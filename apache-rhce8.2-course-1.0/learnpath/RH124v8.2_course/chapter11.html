<html>
<head>
  <title>第十一章 分析与存储日志</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="3384"/>

<div>
<span><div><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第十一章 分析与存储日志</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>查找和准确解读系统事件的日志，以满足故障排除。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>描述系统日志架构</div></li><li><div>查看Syslog文件</div></li><li><div>查看系统日志条目</div></li><li><div>保留系统日志</div></li><li><div>维护准确的时间</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：描述系统日志架构</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能描述RHEL用于记录事件的基本日志架构。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">系统日志：</span></div><ul><li><div>进程和内核都会记录日志，有助于进行故障排除。</div></li><li><div>系统日志保存在/var/log目录中，使用less和tail命令可以查看。</div></li><li><div><span style="font-weight: bold;">RHEL日志基于Syslog协议，systemd-journald和rsyslog服务处理syslog日志。</span></div></li><li><div>systemd-journald是日志架构核心，记录几乎所有事件消息并存放到带索引的数据库中，</div></li></ul><div>     包括内核、引导过程早期的输出、守护进程的标准输出及标准错误等。</div><ul><li><div><span style="font-weight: bold;">systemd-journald默认将日志记录在内存中，系统重启后将丢失所有的日志信息。</span></div></li><li><div><span style="font-weight: bold;">rsyslog从数据库中读取systemd-journald的日志，根据配置文件的定义进行日志存放。</span></div></li></ul><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span>必须启动systemd-journald服务，才能使用rsyslog服务！</div><ul><li><div>rsyslog对日志按照优先级进行分类存放。</div></li></ul></div><ul><li><div>常见的日志文件，如下所示：</div></li></ul><div>     <img src="chapter11_files/Image.png" type="image/png" data-filename="Image.png" width="501"/></div><div>     <img src="chapter11_files/Image [1].png" type="image/png" data-filename="Image.png" width="501"/></div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>     1. <span style="font-weight: bold;">systemd-journald守护进程可记录系统启动早期的事件，较rsyslog守护进程启动早。</span></div><div>     <img src="chapter11_files/Image [2].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     2. 有些应用或服务不使用syslog管理日志，但其依然将日志保存于/var/log目录中，</div><div>        如Apache Web Server。</div><div>     3. <span style="font-weight: bold;">$ man 5 rsyslog.conf</span>：查看rsyslog服务的主配置文件信息</div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P348：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">DESCRIBING SYSTEM LOG ARCHITECTURE</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：查看Syslog文件</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能解读相关syslog日志文件中的事件，以对问题进行故障排除或</div></li></ul><div>     查看系统状态。</div><div><br/></div><div><span style="font-weight: bold;">将事件记录到系统：</span></div><ul><li><div>使用man 5 rsyslog.conf命令可查看日志记录的类型（facility）与优先级（priority）。</div></li><li><div>syslog子系统记录的日志具有8个等级，如下所示：</div></li></ul><div>     <img src="chapter11_files/Image [3].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>rsyslog服务的主配置文件（全局配置）：<span style="font-weight: bold;">/etc/rsyslog.conf</span></div></li><li><div>rsyslog服务的个性化配置文件：<span style="font-weight: bold;">/etc/rsyslog.d/*.conf</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">rsyslog规则示例：</span></div><ul><li><div>$ cat /etc/rsyslog.conf：查看rsyslog主配置文件定义的规则</div></li></ul><div>     <img src="chapter11_files/Image [4].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">日志文件轮转：</span></div><ul><li><div>logrotate工具轮转日志文件，防止/var/log空间将文件系统占满。</div></li><li><div>轮转时，重命名日志文件（添加时间戳），并创建新的空日志文件。</div></li><li><div>轮转若干次（默认4次），丢弃最旧的日志文件，释放磁盘空间。</div></li></ul><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       <span style="font-weight: bold;">/etc/logrotate.conf</span>：日志轮询主配置文件</div><div>     <img src="chapter11_files/Image [5].png" type="image/png" data-filename="Image.png" width="496"/></div><div><br/></div><ul><li><div>每天都会计划运行logrotate程序，轮转频率依据配置文件定义。</div></li><li><div><span style="font-weight: bold;">$ man logrotate</span>：查看logrotate命令使用与日志轮询配置参数信息</div></li></ul><div><br/></div><div><span style="font-weight: bold;">分析日志条目：</span></div><ul><li><div>日志文件在末尾显示最新的信息，信息记录采用标准格式。</div></li><li><div>以/var/log/secure为例，如下所示：</div></li></ul><div>     <img src="chapter11_files/Image [6].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">监控日志：</span></div><ul><li><div>使用tail命令监控实时日志信息。</div></li></ul><div>     <img src="chapter11_files/Image [7].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div></div><div><span style="font-weight: bold;">手动发送syslog消息：</span></div><ul><li><div><span style="font-weight: bold;">$ logger -p &lt;</span><span style="font-style: italic; font-weight: bold;">facility</span><span style="font-weight: bold;">&gt;.&lt;</span><span style="font-style: italic; font-weight: bold;">priority</span><span style="font-weight: bold;">&gt; &quot;&lt;</span><span style="font-style: italic; font-weight: bold;">message_content</span><span style="font-weight: bold;">&gt;&quot;</span></div></li></ul><div>     # 指定日志信息facility、priority与消息内容</div><div>     # 默认情况下使用user.notice</div><div>     <img src="chapter11_files/Image [8].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P356：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">REVIEWING SYSLOG FILES</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第三节：查看系统日志条目</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能查找和解读系统日志中的条目，以对问题进行故障排除</div></li></ul><div>     或查看系统状态。</div><div><br/></div><div><span style="font-weight: bold;">查找事件：</span></div><ul><li><div><span style="font-weight: bold;">systemd-journald将日志存放在带索引的结构化二进制journal文件中，存放在/run/log目录中。</span></div></li></ul><div>     <img src="chapter11_files/Image [9].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><ul><li><div>journalctl命令可用于检索日志信息，建议以root用户执行。</div></li></ul><div>     <img src="chapter11_files/Image [10].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div>优先级为noteice或warning的日志显示为加错文本，error及以上的日志显示为红色文本。</div></li><li><div>journalctl常用命令：</div></li></ul><div>     $ journalctl -n &lt;<span style="font-style: italic;">number</span>&gt;</div><div>     # 指定显示最后10条日志，也可以指定条目数量。</div><div><br/></div><div>     <span style="font-weight: bold;">$ journalctl -f</span></div><div>     # 实时刷新日志，类似于tailf或tail -f命令。</div><div><br/></div><div>     <span style="font-weight: bold;">$ journalctl -p &lt;</span><span style="font-style: italic; font-weight: bold;">priority</span><span style="font-weight: bold;">&gt;</span></div><div>     # 显示debug、info、notice、warning、err、crit、alert和emerg该级别及其之上的日志。</div><div><br/></div><div>     <span style="font-weight: bold;">$ </span><span style="font-weight: bold;">journalctl --since --until &quot;YYYY-MM-DD hh:mm:ss&quot;</span></div><div>     # 显示指定时间范围内的日志，必须使用双引号。</div><div>     # 如果省略日期，则命令会假定日期为当天；如果省略时间，则命令假定为自 00:00:00 起的整天。</div><div>     # yesterday、today与tomorrow可以指定日志时间段，可参考 systemd.time(7) man 帮助。</div><div>     <img src="chapter11_files/Image [11].png" type="image/png" data-filename="Image.png" width="497"/></div><div>     <img src="chapter11_files/Image [12].png" type="image/png" data-filename="Image.png" width="497"/></div><div>     <img src="chapter11_files/Image [13].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ </span><span style="font-weight: bold;">journalctl -o verbose</span>：显示更加详细的日志信息</div><div>     <img src="chapter11_files/Image [14].png" type="image/png" data-filename="Image.png" width="577"/>     </div><div><br/></div><ul><li><div>journalctl配合以下字段，可以搜索特定内容的日志。</div></li><li><div>可参考 <span style="font-weight: bold;">systemd.journal-filelds(7) man</span> 帮助：</div></li></ul><div>      1. _COMM：命令名称</div><div>      2. _EXE：进程的可执行文件的路径</div><div>      3. _PID：进程PID</div><div>      4. _UID：运行该进程的用户UID</div><div>      5. _SYSTEMD_UNIT：启动该进程的systemd单元  </div><div>     <img src="chapter11_files/Image [15].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P364：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">REVIEWING SYSTEM JOURNAL ENTRIES</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第四节：保留系统日志</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能配置系统日志，以在服务器重启时保留事件记录。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">永久存储系统日志：</span></div><ul><li><div>默认情况下，system journals保存在内存/run/log/journal目录中，系统重启</div></li></ul><div>     会被清除。</div><ul><li><div><span style="font-weight: bold;">/etc/systemd/journald.conf</span>：设置Storage参数实现日志永久保存</div></li></ul><div>     1. persistent：永久保存在/var/log/journal目录中</div><div>     2. voltile：临时保存在/run/log/journal目录中</div><div>     3. auto（默认）：如果有/var/log/journal目录存在，则永久保存，如果没有则临时保存。</div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ man 5 journald.conf</span>：查看/etc/systemd/journald.conf的参数信息</div></li></ul><div>     <img src="chapter11_files/Image [16].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>日志（journal）的大小受到日志轮转机制限制。</div></li><li><div>默认情况下，日志的大小不能超过所处文件系统的10%，也不能造成文件系统的可用空间低于15%。</div></li><li><div>此值可以在/etc/systemd/journald.conf中设置。</div></li></ul><div>     <img src="chapter11_files/Image [17].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><ul><li><div>/etc/systemd/journald.conf中Storage参数修改后，需重启systemd-journald服务。</div></li><li><div><span style="font-weight: bold;">可在/var/log/journal目录中查看二进制journal文件（*.journal）。</span></div></li></ul><div>     <img src="chapter11_files/Image [18].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><ul><li><div>永久存储journal日志后，可使用journalctl命令查看系统启动的次数与启动信息。</div></li><li><div><span style="font-weight: bold;">$ journalctl --list-boots</span>：查看系统引导的条目信息</div></li></ul><div>     <img src="chapter11_files/Image [19].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ journalctl -b &lt;</span><span style="font-style: italic; font-weight: bold;">boot_entry</span><span style="font-weight: bold;">&gt;</span>：查看指定条目的系统引导信息</div><div>     <span style="font-weight: bold;">$ journalctl -b -1</span>：查看前一次系统引导过程信息     </div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P371：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">PRESERVING THE SYSTEM JOURNAL</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第五节：维护准确的时间</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能利用NTP维护准确的时间同步，并且配置时区以确保系统日志和</div></li></ul><div>     日志记录的事件标有正确的时间戳。</div><div><br/></div><div><span style="font-weight: bold;">设置本地时钟与时区：</span></div><ul><li><div>保证系统的准确时间，并及时同步时间非常重要。</div></li><li><div>如，日志时间戳的准确性关系到系统故障的定位与排除、数据库或存储集群的数据一致性等。</div></li><li><div>时间同步采用NTP协议。</div></li><li><div>timedatectl命令常用示例：</div></li></ul><div>     $ timedatectl：显示系统时钟信息；UTC为协调世界时、RTC为本地硬件时间</div><div>     <img src="chapter11_files/Image [20].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     $ timedatectl list-timezones：列出时区数据库</div><div>     <span style="font-weight: bold;">$ tzselect</span>：交互式设置系统时区</div><div>     <span style="font-weight: bold;">$ timedatectl set-timezone &lt;</span><span style="font-style: italic; font-weight: bold;">timezone</span><span style="font-weight: bold;">&gt;</span>：设置系统时区</div><div>     <img src="chapter11_files/Image [21].png" type="image/png" data-filename="Image.png" width="498"/>  </div><div><br/></div><div>     <span style="font-weight: bold;">$ timedatectl set-time &quot;YYYY-MM-DD hh:mm:ss&quot;</span>：设置系统日期与时间</div><div>     <img src="chapter11_files/Image [22].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ timedatectl set-ntp [true|false]</span>：是否启用NTP时间同步</div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span><span style="font-weight: bold;">在RHEL 8中，该命令将对是否使用Chronyd NTP时间同步服务做出调整。</span></div><div>     <img src="chapter11_files/Image [23].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">配置与监控Chronyd：</span></div><ul><li><div>chronyd服务通过与配置的NTP服务器进行同步，使通常不准确的本地硬件时钟（RTC）</div></li></ul><div>     保持正确运行。</div><ul><li><div>如果没有可用的网络连接，chronyd将计算RTC时钟漂移，记录在/etc/chrony.conf</div></li></ul><div>     配置文件指定的driftfile变量中。     </div></div><div><br/></div><ul><li><div>修改/etc/chrony.conf主配置文件可配置NTP时间服务源。</div></li></ul><div>     <img src="chapter11_files/Image [24].png" type="image/png" data-filename="Image.png" width="498"/></div><div>     <img src="chapter11_files/Image [25].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ chronyc sources -v</span>：查看Chrony NTP时间服务同步状态</div></li></ul><div>     <img src="chapter11_files/Image [26].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P378：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">MAINTAINING ACCURATE TIME</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P382：ANALYZING AND STORING LOGS</span></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 