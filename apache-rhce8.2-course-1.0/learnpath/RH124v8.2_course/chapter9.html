<html>
<head>
  <title>第九章 控制服务与守护进程</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="3262"/>

<div>
<span><div><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第九章 控制服务与守护进程</span></div><div><span style="font-size: 12pt;"><br/></span></div><div><span style="font-size: 11pt; font-weight: bold;">目标：</span></div><ul><li><div><span style="font-size: 11pt;">使用Systemd控制与监控网络服务，以及系统守护进程。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>识别自动启动的系统进程</div></li><li><div>控制系统服务</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：识别自动启动的系统进程</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能列出由systemd服务启动的系统守护进程与网络服务，</div></li></ul><div>     以及套接字单元。</div><div><br/></div><div><span style="font-weight: bold;">systemd简介：</span></div><ul><li><div>systemd daemon（守护进程）管理Linux的启动，包括服务的启动和管理。</div></li><li><div>systemd可在系统引导时以及运行中的系统上激活系统资源、服务器守护进程和其他进程。</div></li><li><div>守护进程（daemon）是在后台运行或等待的进程，以执行不同的任务。</div></li><li><div>通常守护进程在系统启动时运行，直到关机时才结束运行。</div></li><li><div>守护进程程序名称一般会有 d 字符结尾。</div></li><li><div>systemd中的service通常指一个或多个守护进程。</div></li><li><div><span style="font-weight: bold;">RHEL 7/8中，PID 1是systemd</span>，提供以下几项功能：</div></li></ul><div>     1. 并行化功能（同时启动多个服务），可提高系统的启动速度。</div><div>     2. 按需启动守护进程，而不需要单独的服务。</div><div>     3. 自动服务依赖关系管理，可以防止超时（timeouts）。</div><div>        如，只有在网络可用时，依赖网络的服务才会尝试启动。</div><div>     4. <span style="color: rgb(0, 0, 255); font-weight: bold;">利用Linux CGroups（控制组）追踪相关进程资源占用。</span></div><div><br/></div><div><span style="color: rgb(0, 0, 255); font-weight: bold;">   * 注意：</span></div><div>     1. 使用systemd作为系统管理进程的其他主流Linux发行版：</div></div><div>        a. SuSE 12 SP3/4、SuSE 15</div><div>        b. Ubuntu LTS 16.04/18.04/18.06 </div><div><br/></div><div><span style="font-weight: bold;">描述服务单元：service unit</span></div><ul><li><div>systemd使用单元（units）管理不同类型对象，常见的单元类型包括：</div></li></ul><div>     1. <span style="font-weight: bold;">.service</span>：系统服务，这种单元用于启动经常访问的守护进程，如httpd.service。</div><div>     2. <span style="font-weight: bold;">.socket</span>：systemd监控的进程间通信（IPC）socket。</div><div>        如果客户端连接socket，systemd将启动一个守护进程并将连接传递给它。</div><div>        socket unit用于延迟系统启动时的服务启动，或者按需启动不常使用的服务。</div><div>     3. .path：特定文件系统更改发生之后，服务才激活，如打印系统。</div><ul><li><div>单元被systemctl命令管理。</div></li></ul><div><br/></div><ul><li><div><span style="font-weight: bold;">$ systemctl -t help</span>：显示所有可用单元</div></li></ul><div>     <img src="chapter9_files/Image.png" type="image/png" data-filename="Image.png" width="276"/></div><div><br/></div><div><span style="font-weight: bold;">列出服务单元：</span></div><ul><li><div><span style="font-weight: bold;">$ systemctl list-units --type=service</span></div></li><div># 该命令默认只列出加载进内存，并为激活状态的服务单元。</div></ul><div>     1. --type=选项指定单元类型，也可指定socket等单元类型。</div><div>     <img src="chapter9_files/Image [1].png" type="image/png" data-filename="Image.png" width="499"/></div><div>     </div><div>     <span style="font-weight: bold;">$ systemctl list-units --type=service --all</span></div><div>     # 列出已加载进内存的所有状态的服务单元</div><div><br/></div><div>     <span style="font-weight: bold;">$ systemctl list-units </span><span style="font-weight: bold;">--type=service --all --state=[loaded|active|running|...]</span></div><div>     # 列出已加载进内存的所有状态的服务单元，并根据指定的state状态筛选服务单元。</div><div>     # --state选项可根据LOAD、ACTIVE、SUB中的字段筛选服务单元</div><div><br/></div><ul><li><div>$ systemctl list-unit-files --type=service</div></li></ul><div>     # 查看所有已安装的服务单元文件状态</div><div>     # systemctl list-units命令只能查看加载进内存的服务单元状态，不能查看已安装</div><div>       但为启用的单元文件状态。</div><div>     <img src="chapter9_files/Image [2].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">查看服务状态：</span></div><ul><li><div>$ systemctl status <span style="font-style: italic;">name.type</span>：查看指定的服务状态</div></li></ul><div>     <img src="chapter9_files/Image [3].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>服务单元信息：</div></li></ul><div>     <img src="chapter9_files/Image [4].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div>systemctl命令输出服务状态：</div></li></ul><div>     <img src="chapter9_files/Image [5].png" type="image/png" data-filename="Image.png" width="500"/></div><div>     <img src="chapter9_files/Image [6].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div><span style="font-weight: bold;">验证服务状态：</span></div><ul><li><div>$ systemctl is-active &lt;<span style="font-style: italic;">name.type</span>&gt;：查看服务是否正在运行</div></li><li><div>$ systemctl is-enabled &lt;<span style="font-style: italic;">name.type</span>&gt;：查看服务是否开机自启动</div></li><li><div>$ systemctl is-failed &lt;<span style="font-style: italic;">name.type</span>&gt;：查看服务是否启动失败</div></li><li><div><span style="font-weight: bold;">$ systemctl --failed --type=service</span>：列出所有失败的单元units</div></li></ul><div>   </div><ul><li><div>systemd相关帮助文档：</div></li></ul><div>     $ man systemd</div><div>     <span style="font-weight: bold;">$ man 5 systemd.unit</span></div><div>     $ man 5 systemd.service</div><div>     $ man 5 systemd.socket</div><div>     $ man systemctl</div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span><span style="font-weight: bold;">systemd守护进程在Linux中的地位</span></div><div>     <img src="chapter9_files/Linux_kernel_unified_hierarchy_cgroups_and_systemd.png" type="image/png" data-filename="Linux_kernel_unified_hierarchy_cgroups_and_systemd.png" width="576"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P293：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">IDENTIFYING AUTOMATICALLY STARTED SYSTEM PROCESSES</span></div><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">第二节：控制系统服务</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能使用systemctl控制系统守护进程与网络服务。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">启动与停止服务：</span></div><ul><li><div>$ systemctl start &lt;<span style="font-style: italic;">name</span>&gt;.service：启动服务</div></li><li><div><span style="font-weight: bold;">$ systemctl start &lt;</span><span style="font-style: italic; font-weight: bold;">name</span><span style="font-weight: bold;">&gt;</span>：如果不指明单元类型，默认使用service类型。</div></li><li><div>$ systemctl stop &lt;<span style="font-style: italic;">name</span>&gt;.service：停止服务</div></li></ul><div><br/></div><div><span style="font-weight: bold;">重新启动与重新加载服务：</span></div><ul><li><div>$ systemctl restart &lt;<span style="font-style: italic;">name</span>&gt;.service：重启服务</div></li><li><div><span style="font-weight: bold;">$ systemctl reload &lt;</span><span style="font-style: italic; font-weight: bold;">name</span><span style="font-weight: bold;">&gt;.service</span>：重载服务（无需重启）</div></li></ul><div>     1. 重载服务只加载更改的服务配置文件至内存，而不终止该服务进程，进程PID保持不变。</div><div>     <img src="chapter9_files/Image [7].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     2. 若在/usr/lib/systemd/system/&lt;<span style="font-style: italic;">name</span>&gt;.service中具有 <span style="font-weight: bold;">ExecReload=</span> 参数，可重载该服务。</div><ul><li><div>$ systemctl restart-or-reload &lt;<span style="font-style: italic;">name</span>&gt;.service：优先重载服务，不行则重启服务。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">列出单元依赖关系：</span></div><ul><li><div>有些服务要求首先运行其它服务，因此需要创建依赖项。</div></li><li><div>服务可能并不在系统引导时启动，而是仅在需要时启动。</div></li><li><div>systemd和systemctl可以根据需要启动服务及其依赖的服务。</div></li></ul><div><br/></div><ul><li><div><span style="font-weight: bold;">$ systemctl list-dependencies &lt;</span><span style="font-style: italic; font-weight: bold;">unit</span><span style="font-weight: bold;">&gt;</span>：列出单元unit的依赖关系</div></li><li><div><span style="font-weight: bold;">$ systemctl list-dependencies &lt;</span><span style="font-style: italic; font-weight: bold;">unit</span><span style="font-weight: bold;">&gt; --reverse</span>：列出单元unit的反向依赖关系</div></li></ul><div>     <img src="chapter9_files/Image [8].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div><span style="font-weight: bold;">屏蔽未屏蔽的服务：masking and unmasking</span></div><ul><li><div>系统中的不同服务可能会彼此冲突，如postfix和sendmail。</div></li><li><div>systemctl mask命令屏蔽服务，可防止管理员意外启动与其他服务冲突的服务。</div></li><li><div><span style="font-weight: bold;">屏蔽操作会创建指向/dev/null文件的链接，该文件可阻止服务启动。</span></div></li></ul><div>     <img src="chapter9_files/Image [9].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. 禁用（disabled）的服务只是不在系统引导时启动，可以手动或由其他单元unit文件启动。</div><div>       2. 屏蔽的服务无法手动启动或自动启动，需取消屏蔽后才可启动。</div><div>       <img src="chapter9_files/Image [10].png" type="image/png" data-filename="Image.png" width="562"/> </div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ systemctl unmask &lt;</span><span style="font-style: italic; font-weight: bold;">name</span><span style="font-weight: bold;">&gt;.service</span>：取消屏蔽服务</div></li></ul><div><br/></div><div><span style="font-weight: bold;">开机启动或不启动服务：</span></div><ul><li><div>$ systemctl enable &lt;<span style="font-style: italic;">name</span>&gt;.service：设置服务开机自启动</div></li><li><div>$ systemctl disable &lt;<span style="font-style: italic;">name</span>&gt;.service：设置服务开机不自启动</div></li><li><div>$ systemctl is-enabled &lt;<span style="font-style: italic;">name</span>&gt;.service：查看服务是否开机自启动</div></li></ul><div>     <img src="chapter9_files/Image [11].png" type="image/png" data-filename="Image.png" width="579"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ systemctl -f enable multi-user.target</span>：开机自动进入命令行（CLI）界面</div></li><li><div><span style="font-weight: bold;">$ systemctl -f enable graphical.target</span>：开机自动进入图形化（GUI）界面</div></li></ul><div><br/></div><div><span style="font-weight: bold;">systemctl命令总结：</span></div><ul><li><div>如下表所示：</div></li></ul><div>     <img src="chapter9_files/Image [12].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div></div><div><span>     参考链接：</span><br/></div><ul><li><div><a href="https://www.ibm.com/developerworks/cn/linux/1407_liuming_init3/">https://www.ibm.com/developerworks/cn/linux/1407_liuming_init3/</a></div></li></ul><div>     <span style="font-weight: bold;">IBM：</span><span style="font-weight: bold;">浅析Linux初始化init系统</span></div><div><span style="font-weight: bold;">     </span><span style="font-weight: bold;"><img src="chapter9_files/Image [13].png" type="image/png" data-filename="Image.png" width="500"/></span></div><ul><li><div><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html">http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html</a></div></li></ul><div>     systemd入门教程：命令篇</div><ul><li><div><a href="http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html">http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html</a></div></li></ul><div>     systemd入门教程：实战篇</div><div><br/></div><div>    <span style="color: rgb(250, 122, 0); font-weight: bold;"> 练习 P301：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CONTROLLING SYSTEM SERVICES</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P305：CONTROLLING SERVICES AND DAEMONS</span></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 