<html>
<head>
  <title>第十章 配置与保护SSH</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="3334"/>

<div>
<span><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第十章 配置与保护SSH</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>使用OpenSSH配置远程系统上的安全命令行服务。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>使用SSH访问远程命令行</div></li><li><div>配置基于SSH密钥的身份认证</div></li><li><div>自定义OpenSSH服务配置</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：使用SSH访问远程命令行</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能使用ssh登录远程系统并运行命令。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">什么是OPENSSH?</span></div><ul><li><div>OpenSSH为Linux提供Secure Shell和SSH协议。</div></li><li><div>SSH协议通过不安全的网络来实现通信加密，可支持SSHv1、SSHv2版本。</div></li><li><div>可以使用ssh命令连接远程系统，也可以在远程系统上直接运行命令。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">安全SHELL示例：</span></div><ul><li><div>登录远程系统</div></li></ul><div>     <img src="chapter10_files/Image.png" type="image/png" data-filename="Image.png" width="497"/></div><div>     <img src="chapter10_files/Image [1].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>在远程系统上运行命令</div></li></ul><div>     <img src="chapter10_files/Image [2].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div><span style="font-weight: bold;">识别远程用户：</span></div><ul><li><div>使用w命令以识别远程登录的用户</div></li></ul><div>     <img src="chapter10_files/Image [3].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><div><span style="font-weight: bold;">SSH主机密钥：</span></div><ul><li><div>SSH通过公钥加密的方式保持通信安全。</div></li><li><div>当SSH客户端连接到SSH服务器时，在该客户端登录之前，服务器会向其发送公钥副本。</div></li><li><div>这可用于设置通信的安全加密，并可验证客户端的机器。</div></li><li><div><span style="font-weight: bold;">当用户使用ssh命令连接到SSH服务器时，该命令会检查它在本地已知主机文件（/etc/ssh/ssh_known_hosts</span></div></li></ul><div><span style="font-weight: bold;">     或~/.ssh/known_hosts）中是否有该服务器的公钥副本。</span></div><ul><li><div>系统管理员可在/etc/ssh/ssh_known_hosts中进行配置，或者用户的主目录中添加包含服务端公钥的</div></li></ul><div>     ~/.ssh/known_hosts文件。</div><ul><li><div>如果客户端的已知主机文件中没有公钥的副本，ssh命令会询问是否仍要登录。</div></li><li><div>如果仍进行登录，公钥的副本就将保存到~/.ssh/known_hosts文件中，以便将来自动确认服务器身份。</div></li></ul><div>     <img src="chapter10_files/Image [4].png" type="image/png" data-filename="Image.png" width="498"/></div><ul><li><div>如果客户端有公钥的副本，ssh就会将该服务器已知主机文件中的公钥与它收到的公钥进行对比。</div></li><li><div>如果公钥不匹配，客户端会假定服务器的网络流量已遭劫持或服务器已被入侵，并且请求用户确认</div></li></ul><div>     是否要继续连接。</div><div><br/></div><div><span style="color: rgb(0, 0, 255); font-weight: bold;">   * 注意：</span></div><div>     1. 在特定于用户的~/.ssh/config文件或系统范围的/etc/ssh/ssh_config中将 <span style="font-weight: bold;">StrictHostKeyChecking</span> </div><div>        参数设为yes，使得ssh命令在公钥不匹配时始终中断SSH连接。</div><div>     2. <span style="font-weight: bold;">$ man 5 ssh_config</span>：查看ssh客户端使用与参数含义</div><div>        <img src="chapter10_files/Image [5].png" type="image/png" data-filename="Image.png" width="555"/></div><div>        </div><div>     3. 可设置 StrictHostKeyChecking 参数分别为ask、yes、no以匹配SSH服务端公钥，</div><div>        默认为ask，提示SSH客户端是否信任该SSH服务端公钥。</div><div>     4. <span style="font-weight: bold;">ssh命令的参数优先级：命令行大于配置文件，可在命令行直接指定。</span></div><div>        <img src="chapter10_files/Image [6].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div><span style="font-weight: bold;">SSH已知主机公钥管理：</span></div><ul><li><div>如果由于硬盘驱动器故障而导致服务端公钥丢失或由于某些原因而导致公钥更换，则需要编辑</div></li></ul><div>     客户端已知的主机文件以确保将旧服务端公钥条目替换为新公钥条目，确保登录时不产生错误。</div><ul><li><div><span style="font-weight: bold;">客户端将服务端公钥存储在 /etc/ssh/ssh_known_hosts 或SSH客户端上每个用户的 ~/.ssh/known_hosts。</span></div></li><li><div>每个公钥各占一行。</div></li><li><div>第一个字段是共享该公钥的主机名和IP地址的列表。</div></li><li><div>第二个字段是公钥的加密算法。</div></li><li><div>最后一个字段是公钥本身。</div></li></ul><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span>由于SSH服务端公钥改变，模拟中间人攻击：</div><div>     <img src="chapter10_files/Image [7].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>SSH服务端的公钥存储路径：<span style="font-weight: bold;">/etc/ssh/*key.pub</span></div></li></ul><div>     <img src="chapter10_files/Image [8].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P315：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">ACCESSING THE REMOTE COMMAND LINE</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：配置基于SSH密钥的身份认证</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能将用户账户配置为使用基于密钥的⾝份验证来安全地登录远程系统，</div></li></ul><div>     并且无需输入密码。</div><div><br/></div><div><span style="font-weight: bold;">基于SSH密钥的身份验证：</span></div><ul><li><div>基于私钥-公钥（private-public key）可以配置SSH服务器，不输入密码就能登录服务器。</div></li><li><div>用户必须生成公私密钥对，其中私钥保存于SSH客户端，用于身份验证解密，必须妥善保管。</div></li><li><div>公钥复制到希望连接的远程系统上，用于验证私钥，公钥不需要保密。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">生成SSH密钥：</span></div></div><ul><li><div>ssh-keygen命令创建用户的公钥和私钥，创建过程中要求交互输入密码用于加密私钥，</div></li></ul><div>     其公私钥密钥对默认保存于 ~/.ssh/id_rsa 和 ~/.ssh/id_rsa.pub 文件中。</div><div>     <img src="chapter10_files/Image [9].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ ssh-keygen -f &lt;</span><span style="font-style: italic; font-weight: bold;">key_name</span><span style="font-weight: bold;">&gt;</span>：指定SSH私钥名称生成公私钥密钥对</div></li></ul><div>     <img src="chapter10_files/Image [10].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">共享公钥：</span></div><ul><li><div>ssh-copy-id命令可以将用户的SSH公钥（默认~/.ssh/id_rsa.pub）复制到目标系统</div></li></ul><div>     指定用户的~/.ssh/authorized_keys中。</div><div><br/></div><ul><li><div>若生成的公私钥密钥对为指定的文件，共享公钥时需指定公钥文件。</div></li></ul><div><span style="font-weight: bold;">     $ ssh-copy-id -i <span style="font-weight: bold; color: rgb(0, 0, 255);">~/.ssh/&lt;</span></span><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">key_name</span><span style="font-weight: bold;"><span style="font-weight: bold; color: rgb(0, 0, 255);">&gt;.pub</span> &lt;</span><span style="font-style: italic; font-weight: bold;">remote_user</span><span style="font-weight: bold;">&gt;@&lt;</span><span style="font-style: italic; font-weight: bold;">remote_host</span><span style="font-weight: bold;">&gt;</span></div><div>     <img src="chapter10_files/Image [11].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>使用指定的公钥免密登录SSH服务端时，SSH客户端需指定相应私钥。</div></li></ul><div>     <span style="font-weight: bold;">$ ssh -i </span><span style="color: rgb(0, 0, 255); font-weight: bold;">~/.ssh/&lt;</span><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">key_name</span><span style="font-weight: bold;"><span style="font-weight: bold; color: rgb(0, 0, 255);">&gt;</span> &lt;</span><span style="font-style: italic; font-weight: bold;">remote_user</span><span style="font-weight: bold;">&gt;@&lt;</span><span style="font-style: italic; font-weight: bold;">remote_host</span><span style="font-weight: bold;">&gt;  </span></div><div>     <img src="chapter10_files/Image [12].png" type="image/png" data-filename="Image.png" width="496"/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>     1. <span style="font-weight: bold;">使用指定的私钥免密码登录远程主机常使用于登录云实例（</span><span style="font-style: italic; font-weight: bold;">AWS EC2</span><span style="font-weight: bold;">、</span><span style="font-style: italic; font-weight: bold;">OpenStack instance</span><span style="font-weight: bold;">）。</span></div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* SSH验证方式原理：</span></div><div>     1. 对称加密示意：</div><div>        a. 使用相同密钥加密的数据必须使用该密钥才能解密。</div><div>        <img src="chapter10_files/Image [13].png" type="image/png" data-filename="Image.png" width="358"/></div><div>        <img src="chapter10_files/Image [14].png" type="image/png" data-filename="Image.png" width="358"/> </div><div>     2. 非对称加密示意：公私钥密钥对加密</div><div>        a. 使用公钥加密的数据必须使用私钥解密，反之，使用私钥加密的数据必须使用公钥解密。</div><div>        b. 非对称加密的安全强度高。</div><div>     3. SSH验证方式包括：结合对称加密与非对称加密</div><div>        a. 基于密码的验证（password-based）</div><div>        b. 基于SSH密钥验证（key-based）</div><div>        c. GSSAPI Kerberos验证</div><div>     4. 通常使用前两种方式实现验证。</div><div>     5. 基于密码的验证原理：</div><div>        a. 当客户端发起SSH请求，服务器会将其公钥发送给客户端。</div><div>        b. 客户端根据服务端发来的公钥对登录密码进行加密</div><div>        c. 加密后的信息回传给服务端，服务端用其私钥解密，将解密的密码与本地用户的密码进行比对，</div><div>           两者一致则用户登录成功，不一致则用户登录失败。</div><div>        <img src="chapter10_files/Image [15].png" type="image/png" data-filename="Image.png" width="419"/></div><div><br/></div><div>     6. SSH服务端公钥传递过程中存在的安全隐患：中间人攻击（<span style="font-weight: bold;">man-in-the-middle attack</span>）</div><div>        a. 在SSH公钥传递过程中如何保证公钥的真实性是安全连接的基础。</div><div>        b. 在SSL/TLS连接中可引入CA证书授权中心验证数字证书的真实性，而在SSH连接中常用ECDSA数字签名</div><div>           算法将服务端公钥生成指纹，方便用于后续连接的公钥比对。</div><div>        c. 第一次连接时SSH客户端需接受服务端公钥，但在该过程中无法确定服务端公钥的真实性，这就取决于对</div><div>           安全性取舍。</div><div>        d. 因此，如果SSH服务端公钥发生改变或SSH服务端更换不同的主机但IP地址保持不变，SSH客户端连接时</div><div>           将提示为中间人攻击（演示过程如上所示）！</div><div>        <img src="chapter10_files/Image [16].png" type="image/png" data-filename="Image.png" width="419"/>                      </div><div><br/></div><div>     7. 基于SSH密钥验证的原理：</div><div>        a. 客户端将自己的公钥存放于服务端的~/.ssh/authorized_keys文件中。</div><div>        b. 服务端接收到客户端的连接请求后，会在~/.ssh/authorized_keys文件中匹配到客户端的公钥pubKey，</div><div>           并生成随机数R，用客户端的公钥对该随机数进行加密得到pubKey(R)，然后将加密后信息发送给Client。</div><div>        c. 客户端通过私钥进行解密得到随机数R，然后对随机数R和本次会话的SessionKey利用MD5生成消息摘要（哈希值）</div><div>           Digest1，发送给服务端。</div><div>        d. 服务端会也对随机数R和SessionKey利用同样消息摘要算法生成Digest2。</div><div>        e. 服务端最后比对Digest1和Digest2是否相同，两者一致完成认证过程。</div><div>        <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span><span style="font-weight: bold;">SessionKey在客户端向服务端发起连接请求后，由双方协商生成。</span></div><div>        <img src="chapter10_files/Image [17].png" type="image/png" data-filename="Image.png" width="422"/></div><div><br/></div><div>     8. SSH客户端与服务端公私钥分布示意：</div><div>        <img src="chapter10_files/Image [18].png" type="image/png" data-filename="Image.png" width="422"/></div><div><br/></div><div>     9. SSH连接过程解析：</div><div>        a. 使用SSH客户端的Debug模式查看远程连接过程，如下所示：</div><div>           <span style="font-weight: bold;">$ ssh [-v|-vv|-vvv] &lt;</span><span style="font-style: italic; font-weight: bold;">remoteuser</span><span style="font-weight: bold;">&gt;@&lt;</span><span style="font-style: italic; font-weight: bold;">remotehost</span><span style="font-weight: bold;">&gt;</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;">   </span> b. SSH服务端可通过WireShark抓包分析SSH过程。 </div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;"> </span>   c. 以下演示基于密码的Debug连接过程：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">[root@master ~]# <b>ssh -v root@192.168.1.165</b></font></div><div><b><font color="#0000FF"><font face="DejaVu Sans Mono" style="font-size: 10pt;">==&gt; </font><font face="DejaVu Sans Mono" style="font-size: 10pt;">第一阶段：双方确认协议版本号和SSH版本号 </font></font></b></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">OpenSSH_6.6.1, OpenSSL 1.0.1e-fips 11 Feb 2013</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Reading configuration data /etc/ssh/ssh_config</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: /etc/ssh/ssh_config line 56: Applying options for *</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Connecting to 192.168.1.165 [192.168.1.165] port 22.</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>Connection established.</i></b>    </font><font face="DejaVu Sans Mono" style="font-size: 10pt;"><b>-&gt; SSH客户端与服务端连接建立</b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: permanently_set_uid: 0/0</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_rsa type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_rsa-cert type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_dsa type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_dsa-cert type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_ecdsa type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_ecdsa-cert type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_ed25519 type -1</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: identity file /root/.ssh/id_ed25519-cert type -1</font></div><div><font face="DejaVu Sans Mono"><span style="font-size: 10pt;">debug1:</span> <b><i><span style="font-size: 10pt;">Enabling compatibility mode for protocol 2.0    -&gt; </span></i></b></font><b><font style="font-size: 10pt;">使用的SSH协议版本：SSHv2</font></b></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>Local version string SSH-2.0-OpenSSH_6.6.1</i></b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>Remote protocol version 2.0, remote software version OpenSSH_7.4</i></b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: match: OpenSSH_7.4 pat OpenSSH* compat 0x04000000</font></div><div><font color="#0000FF"><b><font face="DejaVu Sans Mono" style="font-size: 10pt;">==&gt; </font><font style="font-size: 10pt;">第二阶段：双方确认/支持使用的数据加密算法、消息摘要算法、主机公钥等信息。</font></b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_KEXINIT sent</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_KEXINIT received</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: kex: server-&gt;client aes128-ctr hmac-sha1-etm@openssh.com none</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: kex: client-&gt;server aes128-ctr hmac-sha1-etm@openssh.com none</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: kex: curve25519-sha256@libssh.org need=20 dh_need=20</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: kex: curve25519-sha256@libssh.org need=20 dh_need=20</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: sending SSH2_MSG_KEX_ECDH_INIT</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: expecting SSH2_MSG_KEX_ECDH_REPLY</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Server host key: ECDSA dc:a3:46:59:a8:81:a3:33:5e:30:fa:cb:d8:4d:ca:7b</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">The authenticity of host '192.168.1.165 (192.168.1.165)' can't be established.</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;"><b><i>ECDSA key fingerprint is dc:a3:46:59:a8:81:a3:33:5e:30:fa:cb:d8:4d:ca:7b.    </i></b></font><b><font face="DejaVu Sans Mono" style="font-size: 10pt;">-&gt; SSH服务端的公钥指纹，用于验证其真实性。</font></b></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">Are you sure you want to continue connecting (yes/no)? yes</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">Warning: Permanently added '192.168.1.165' (ECDSA) to the list of known hosts.    <b>-&gt; ~/.ssh/known_hosts</b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>ssh_ecdsa_verify: signature correct    -&gt; </i></b></font><b><font style="font-size: 10pt;">SSH服务端公钥指纹验证通过，其数字签名正确。</font></b></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_NEWKEYS sent</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: expecting SSH2_MSG_NEWKEYS</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_NEWKEYS received</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_SERVICE_REQUEST sent</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: SSH2_MSG_SERVICE_ACCEPT received</font></div><div><font color="#0000FF" face="DejaVu Sans Mono" style="font-size: 10pt;"><b>==&gt; 第三阶段：进入用户身份验证过程</b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i><font color="#FA7A00">Authentications that can continue: publickey,gssapi-keyex,gssapi-with-mic,password</font>    -&gt;</i> SSH支持的多种用户认证方式</b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Next authentication method: <i><b>gssapi-keyex</b></i></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: No valid Key exchange context</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Next authentication method: <i><b>gssapi-with-mic</b></i></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Unspecified GSS failure.  Minor code may provide more information</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">No Kerberos credentials available (default cache: KEYRING:persistent:0)</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;"><br/></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;"><br/></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Unspecified GSS failure.  Minor code may provide more information</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">No Kerberos credentials available (default cache: KEYRING:persistent:0)</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;"><br/></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;"><br/></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Next authentication method: <b><i>publickey</i></b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Trying private key: /root/.ssh/id_rsa</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Trying private key: /root/.ssh/id_dsa</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Trying private key: /root/.ssh/id_ecdsa</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Trying private key: /root/.ssh/id_ed25519</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>Next authentication method: password    </i></b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">root@192.168.1.165's password:</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: <b><i>Authentication succeeded (password).    -&gt; </i>基于密码的验证成功</b></font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">Authenticated to 192.168.1.165 ([192.168.1.165]:22).</font></div><div><b><font color="#0000FF" style="font-size: 10pt;"><font face="DejaVu Sans Mono">==&gt; </font>第四阶段：验证成功后等到一个新的session，及设置环境变量等，最后得到一个shell。</font></b></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: channel 0: new [client-session]</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Requesting no-more-sessions@openssh.com</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Entering interactive session.</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">debug1: Sending environment.</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">Last login: Wed Jan 15 15:51:59 2020 from 192.168.1.210</font></div><div><font face="DejaVu Sans Mono" style="font-size: 10pt;">[root@devops0 ~]# </font></div></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P323：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CONFIGURING SSH KEY-BASED AUTHENTICATION</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第三节：自定义OpenSSH服务配置</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能限制直接以root身份登录，并为OpenSSH服务禁用基于密码的身份验证。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">配置OPENSSH服务器：</span></div><ul><li><div>OpenSSH的守护进程名为sshd，主配置文件为/etc/ssh/sshd_config。</div></li><li><div><span style="font-weight: bold;">$ man 5 sshd_config</span>：查看sshd_config配置文件的参数含义</div></li><li><div>推荐禁用root用户远程登录和基于密码的身份验证（使用公私钥验证方式替代）。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">禁止超级用户使用SSH登录：</span></div><ul><li><div>黑客喜欢猜测root密码</div></li><li><div>root用户具有最高权限</div></li><li><div>建议普通用户进行登录，在有需要时提权成为root用户。</div></li><li><div>SSH守护进程的主配置文件/etc/ssh/sshd_config，默认为 PermitRootLogin yes。</div></li><li><div>修改以上参数为 PermitRootLogin no 以禁止root用户远程登录。</div></li><li><div>若禁止root用户基于密码的远程登录，允许基于密钥的登录，设置为：</div></li></ul><div><span style="font-weight: bold;">     PermitRootLogin without-password</span></div><div>     <img src="chapter10_files/Image [19].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>$ systemctl reload sshd：重载sshd配置文件使其生效</div></li></ul><div>     <img src="chapter10_files/Image [20].png" type="image/png" data-filename="Image.png" width="498"/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. 生产环境中若未正确配置SSH服务及相关安全规则很可能重启（restart）服务后将无法连接！</div><div>       2. 连接SSH服务无响应的可能情况：</div><div><span>    </span><span>      a. 网络原因：</span></div><div><span><span>    </span><span>    </span><span>     * </span>主机网络原因：网络与路由配置错误、网卡（网络接口）故障、网线松动、网线故障、线序插错等。</span></div><div><span><span>    </span><span>    </span><span>     * </span>交换机与路由器原因：网络接口故障、网线松动、网线故障、线序插错、VLAN配错、路由配错等。</span><br/></div><div><span><span>    </span><span>      b. SSH服务验证原因：</span><br/></span></div><div><span>    </span><span>    </span><span>     * </span>/etc/ssh/sshd_config配置问题：root用户登录、密码/公钥验证、允许登录的用户白名单等。</div><div><span>    </span><span>         * </span>PAM安全认证问题：/etc/pam.d/sshd中 pam_listfile.so 模块的参数配置</div><div><span><span>    </span><span>    </span><span>     * </span>应用层防火墙问题：/etc/hosts.allow、/etc/hosts.deny</span></div><div><span>    </span><span>      c. 远程连接终端工具原因：多次尝试</span></div><div><span>    </span><span>    </span><span>     * SecureCRT 7/8</span></div><div><span>    </span><span>    </span><span>     * XShell 5/6</span></div><div><span><span>    </span><span>    </span><span>     *</span> </span>PuTTY</div><div><br/></div><div><span style="font-weight: bold;">禁止对SSH进行基于密码的身份验证：</span></div><ul><li><div>黑客无法通过猜测用户密码攻击已知用户</div></li><li><div>密码相对于公私钥保密性差</div></li><li><div>SSH守护进程的主配置文件/etc/ssh/sshd_config，默认为 PasswordAuthentication yes，</div></li></ul><div>     将其修改为 <span style="font-weight: bold;">PasswordAuthentication no</span>。</div><ul><li><div>修改配置后，执行systemctl reload sshd重载只配置文件，使其生效。</div></li></ul><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P331：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CUSTOMIZING OPENSSH SERVICE CONFIGURATION</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P337：CONFIGURING AND SECURING SSH</span></div><div><br/></div><div><br/></div></div><div><br/></div><div><br/></div></span>
</div></body></html> 