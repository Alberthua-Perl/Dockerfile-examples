<html>
<head>
  <title>第十二章 安装红帽企业Linux</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="9354"/>

<div>
<span><div><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第十二章 安装红帽企业Linux</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div><span style="font-weight: bold;">在服务器和虚拟机上安装红帽企业Linux。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>安装红帽企业Linux</div></li><li><div>使用Kickstart自动安装</div></li><li><div>安装和配置虚拟机</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：安装红帽企业Linux</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能在服务器上安装红帽企业Linux。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">选择安装介质：</span></div><ul><li><div>红帽提供了几种安装介质，可使用自己的有效订阅从客户门户网站中下载。</div></li></ul><div>     1. <span style="font-weight: bold;">DVD iso文件：</span></div><div>        a. 含有Anaconda、BaseOS 和 AppStream 软件包仓库。</div><div>        b. iso映像中包含安装所需的所有软件包。</div><div>     2. <span style="font-weight: bold;">含有Anaconda的启动iso文件：</span></div><div>        a. 它需要配置网络，以便通过HTTP、FTP或NFS访问软件仓库。</div><div>     3. <span style="font-weight: bold;">含有预构建系统磁盘的QCOW2映像：</span></div><div>        a. 可在云或虚拟化环境中部署为虚拟机。</div><div>        b. QCOW2（QEMU Copy On Write）是红帽使用的标准镜像格式。</div><div>        c. 红帽为四种处理器架构提供安装介质：</div><div>           1）x86 64 位（AMD和Intel）</div><div>           2）IBM Power Systems（Little Endian）</div><div>           3）IBM Z</div><div>           4）ARM 64 位</div></div><div><br/></div><div><span style="font-weight: bold;">使用Composer构建镜像：</span></div><ul><li><div><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">Composer</span> 是RHEL 8中的新工具。</div></li><li><div>管理员可以构建自定义系统镜像，以便在云平台或虚拟环境中部署。</div></li><li><div><span style="font-weight: bold;">Composer使用</span> <span style="font-weight: bold;">Cockpit</span> <span style="font-weight: bold;">图形化控制台，也可使用 composer-cli 命令行工具。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">通过Anaconda安装系统的两种方法：</span></div><ul><li><div>手动安装将与用户进行交互</div></li><li><div>自动安装将使用Kickstart文件，它会告诉Anaconda如何安装系统。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">使用图形界面安装RHEL：</span>略</div><div><br/></div><div><span style="font-weight: bold;">对安装进行故障排除：</span></div><ul><li><div>在RHEL 8安装期间，Anaconda提供了两个虚拟控制台。</div></li><li><div>第一个虚拟控制台有五个窗口，它们由 tmux 提供，可通过 Ctrl+Alt+F1 访问该控制台。</div></li><li><div>第二个虚拟控制台（默认）显示图形界面，可通过 Ctrl+Alt+F6 来访问该控制台。</div></li></ul><div>     <img src="chapter12_files/Image.png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>在第一个虚拟控制台中，tmux 在第二个窗口中提供了shell提示符，以便在安装过程中检查</div></li></ul><div>     系统并进行故障排除。</div><div>     <img src="chapter12_files/Image [1].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div>另外的窗口中提供了诊断消息、日志及其他信息。</div></li></ul><div>     <img src="chapter12_files/Image [2].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P338：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">INSTALLING RED HAT ENTERPRISE LINUX</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：使用Kickstart自动安装</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  讲解Kickstart概念和架构。</div></li><li><div>  使用Kickstart Generator网站创建Kickstart文件。</div></li><li><div>  使用文本编辑器修改现有Kickstart文件，并使用ksvalidator检查其语法。</div></li><li><div>  将Kickstart文件发布到安装程序。</div></li><li><div>  执行网络Kickstart安装。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">创建Kickstart配置文件：</span></div><ul><li><div>管理员可使用Kickstart来自动安装RHEL。</div></li><li><div>作为RHEL的安装程序Anaconda，需要知道如何安装操作系统。</div></li><li><div>Kickstart的配置文件里面包含了所有安装需要的数据，就不需要人机交互安装了。</div></li></ul><div><br/></div><ul><li><div>Kickstart配置文件开头是指令列表，定义了目标系统如何被安装。</div></li><li><div>行的开头如为 #，会被忽略。</div></li><li><div>附加段落以 % 开头，%end 结尾。</div></li><li><div>%package 段定义需要安装的软件：</div></li></ul><div>     1. 内容为软件名（不含版本）或包组名（以 @ 开头）</div><div>     2. <span style="font-weight: bold;">包组内包含 mandatory、default 和 optional 三种类型的软件包。</span></div><div>     3. <span style="font-weight: bold;">Kickstart安装默认安装 mandatory 和 default 包。</span></div><div>     4. 软件包名前加 &quot;-&quot; 表示不安装，除非该软件包为 mandatory 或其它软件的依赖包。</div><ul><li><div>%pre 段中的脚本在磁盘分区前执行，较少使用。</div></li><li><div><span style="font-weight: bold;">%post 段中的脚本在软件包安装完成后执行，较为常用。</span></div></li><li><div>%pre、%post、%packages 顺序无关紧要。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">Kickstart文件命令：</span></div><ul><li><div>安装命令：</div></li></ul><div>     1. <span style="font-weight: bold;">url</span>：指定安装介质的URL</div><div>        url --url=&quot;<a href="http://classroom.example.com/content/rhel8.0/x86_64/dvd/">http://classroom.example.com/content/rhel8.0/x86_64/dvd/&quot;</a></div><div><br/></div><div>     2. <span style="font-weight: bold;">repo</span>：指定到哪里查找要安装的其他软件包，此选项必须指向有效的yum存储库。 </div><div>        repo --name=&quot;appstream&quot; \</div><div>        --baseurl=<a href="http://classroom.example.com/content/rhel8.0/x86_64/dvd/AppStream/">http://classroom.example.com/content/rhel8.0/x86_64/dvd/AppStream/</a></div><div><br/></div><div>     3. <span style="font-weight: bold;">text</span>：强制文字化安装</div><div>     4. <span style="font-weight: bold;">vnc</span>：定义图形化安装过程可以通过vnc远程查看</div><div>        vnc --password=redhat</div><div><br/></div><ul><li><div>分区命令：</div></li></ul><div>     1. <span style="font-weight: bold;">clearpart</span>：安装前清空指定分区内容</div><div>        clearpart --all --drives=sda,sdb --initlabel</div><div><br/></div><div>     2. <span style="font-weight: bold;">part</span>：定义分区大小、格式、名称</div><div>        part /home --fstype=ext4 --label=homes --size=4096 --maxsize=8192 --grow</div><div><br/></div><div>     3. <span style="font-weight: bold;">ignoredisk</span>：安装时忽略特定磁盘</div><div>        ignoredisk --drives=sdc</div><div><br/></div><div>     4. <span style="font-weight: bold;">bootloader</span>：定义安装bootloader到哪个磁盘</div><div>        bootloader --location=mbr --boot-drive=sda</div><div><br/></div><div>     5. <span style="font-weight: bold;">volgroup,logvol</span>：创建LVM卷组和逻辑卷</div><div>        part pv.01 --size=8192</div><div>        volgroup myvg pv.01</div><div>        logvol / --vgname=myvg --fstype=xfs --size=2048 --name=rootvol --grow</div><div>        logvol /var --vgname=myvg --fstype=xfs --size=4096 --name=varvol</div><div><br/></div><div>     6. <span style="font-weight: bold;">zerombr</span>：如果磁盘格式不能识别就初始化</div><div><br/></div><ul><li><div>网络命令：</div></li></ul><div>     1. <span style="font-weight: bold;">network</span>：定义网卡配置，并在安装环境中激活。</div><div>        network --device=eth0 --bootproto=dhcp</div><div><br/></div><div>     2. <span style="font-weight: bold;">firewall</span>：定义目标系统中防火墙的配置</div><div>        firewall --enabled --service=ssh,http</div><div><br/></div><ul><li><div>位置和安全命令：</div></li></ul><div>     1. <span style="font-weight: bold;">lang</span>：定义安装过程和系统的默认语言</div><div>        lang en_US.UTF-8</div><div><br/></div><div>     2. <span style="font-weight: bold;">keyboard</span>：定义系统默认键盘布局</div><div>        keyboard --vckeymap=us --xlayouts=''</div><div><br/></div><div>     3. <span style="font-weight: bold;">timezone</span>：定义时区，NTP服务器，硬件时钟是否使用UTC。</div><div>        timezone --utc --ntpservers=<a href="http://time.example.com/">time.example.com</a> Europe/Amsterdam</div><div><br/></div><div>     4. <span style="font-weight: bold;">authselect</span>：定义操作系统的用户认证选项，查阅 man 8 authselect。</div><div>     5. <span style="font-weight: bold;">rootpw</span>：定义root初始密码</div><div>        rootpw --plaintext redhat</div><div>        rootpw --iscrypted $6$KUnFfrTzO8jv.PiH$YlBbOtXBkWzoMuRfb0.SpbQ....XDR1UuchoMG1</div><div><br/></div><div>     6. <span style="font-weight: bold;">selinux</span>：定义目标系统的SELinux模式</div><div>        selinux --enforcing</div><div><br/></div><div>     7. <span style="font-weight: bold;">services</span>：定义在默认的 runlevel 下启动哪些服务，关闭哪些服务。</div><div>        services --disabled=network,iptables,ip6tables --enabled=NetworkManager,firewalld</div><div><br/></div><div>     8. <span style="font-weight: bold;">group,user</span>：定义添加哪些本地用户和组</div><div>        group --name=admins --gid=10001</div><div>        user --name=jdoe --gecos=&quot;John Doe&quot; --groups=admins --password=changeme --plaintext</div><div><br/></div><ul><li><div>杂项命令：</div></li></ul><div>     1. <span style="font-weight: bold;">logging</span>：定义安装过程如何写入日志</div><div>        logging --host=<a href="http://loghost.example.com/">loghost.example.com</a> --level=info</div><div><br/></div><div>     2. <span style="font-weight: bold;">firstboot</span>：定义第一次启动是否启动配置页面</div><div>        firstboot --disabled</div><div><br/></div><div>     3. <span style="font-weight: bold;">reboot,poweroff,halt</span>：定义安装完毕后做什么</div><div><br/></div><div><span style="font-weight: bold;">Kickstart文件示例：</span></div><ul><li><div>该文件的第一部分由安装命令组成，如磁盘分区和安装源等。</div></li></ul><div>     <img src="chapter12_files/Image [3].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>第二部分包含 %packages 部分，说明应当安装的软件包和软件包组，以及不安装的软件包。</div></li></ul><div>     <img src="chapter12_files/Image [4].png" type="image/png" data-filename="Image.png" width="442"/></div><div><br/></div><ul><li><div>最后一个部分包含所有 %pre 和 %post 安装脚本。</div></li></ul><div>     <img src="chapter12_files/Image [5].png" type="image/png" data-filename="Image.png" width="443"/></div><div><br/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       在Kickstart文件中，缺少必需值会导致安装程序中断并以交互方式提示用户输入答案</div><div>       或完全中止安装。 </div><div><br/></div><div><span style="font-weight: bold;">Kickstart安装步骤：</span></div><ul><li><div>要想成功地自动安装红帽企业Linux，请按照以下步骤操作：</div></li></ul><div>     1. 创建Kickstart文件。</div><div>     2. 将Kickstart文件发布到安装程序。</div><div>     3. 启动Anaconda并将其指向Kickstart文件。</div><div><br/></div><div><span style="font-weight: bold;">创建Kickstart文件：</span></div><ul><li><div>使用Kickstart Generator网站：<a href="https://access.redhat.com/labs/kickstartconfig/">https://access.redhat.com/labs/kickstartconfig/</a></div></li><li><div>该网站需红帽订阅的用户使用。</div></li></ul><div>     <img src="chapter12_files/Image [6].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>使用文本编辑器：</div></li></ul><div>     1. 从头开始创建Kickstart过于复杂，建议编辑现有的Kickstart文件。</div><div>     2. 每个安装都会创建 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">/root/anaconda-ks.cfg</span> 文件，其中包含了该安装中使用的 </div><div>        Kickstart指令，可以参考该文件来生成新的Kickstart文件。</div><div>     3. <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">ksvalidator</span> 可检查Kickstart文件中语法错误。</div><div>     4. <span style="font-weight: bold;">它将确保关键字和选项的正确使用，但无法验证URL路径、单个软件包或组，也无法验证</span></div><div><span style="font-weight: bold;">        %post 或 %pre 脚本（pykickstart软件包提供）。</span></div><div><span style="font-weight: bold;">        </span><span style="font-weight: bold;"><img src="chapter12_files/Image [7].png" type="image/png" data-filename="Image.png" width="475"/></span><span style="font-weight: bold;">              </span></div><div><br/></div><div><span style="font-weight: bold;">将Kickstart文件发布到Anaconda：</span></div><ul><li><div>安装程序支持以下位置存放的Kickstart文件：</div></li></ul><div>     1. FTP、HTTP或NFS网络服务器</div><div>     2. USB磁盘或CD-ROM</div><div>        <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span>Kickstart文件需提前封装入CD-ROM中，BIOS与UEFI固件引导的封装方式存在差异！</div><div>     3. 系统上要安装的本地硬盘</div><ul><li><div>安装程序必须访问Kickstart文件，然后才能开始自动安装。</div></li></ul></div><div><br/></div><div><span style="font-weight: bold;">启动Anaconda并将其指向Kickstart文件：</span></div><ul><li><div>选择某种Kickstart方法后，通过将 <span style="color: rgb(0, 0, 255); font-weight: bold;">inst.ks=</span><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">LOCATION </span>参数传递给安装内核，安装程序就会</div></li></ul><div>     知道在何处查找Kickstart文件。</div><ul><li><div>如下示例：</div></li></ul><div>     inst.ks=<a href="http://server/dir/">http://server/dir/</a>ﬁle</div><div>     inst.ks=<a href="ftp://server/dir/">ftp://server/dir/</a>ﬁle</div><div>     inst.ks=nfs:server:/dir/ﬁle</div><div>     inst.ks=hd:device:/dir/ﬁle</div><div>     inst.ks=cdrom:device</div><div>     <img src="chapter12_files/Image [8].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><ul><li><div>使用Virtual Machine Manager或virt-manager安装操作系统，可以在URL Options下的</div></li></ul><div>     框中指定 Kickstart URL。</div><ul><li><div>安装物理计算机时，按 Tab 键中断启动过程，向安装内核中添加 inst.ks=<span style="font-style: italic;">LOCATION</span> 参数。</div></li></ul><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>     <b>PXE与Kickstart无人值守安装系统原理：</b></div><div><span>     </span><img src="chapter12_files/1.jpg" type="image/jpeg" data-filename="1.jpg" width="407"/> </div><div><span>     </span><img src="chapter12_files/2.jpg" type="image/jpeg" data-filename="2.jpg" width="406"/><br/></div><div><br/></div><div>     参考文档：</div><div><span style="font-weight: bold;">     1. RHEL 8高级安装中Kickstart方式的说明：</span></div><div>     <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/pdf/performing_an_advanced_rhel_installation/Red_Hat_Enterprise_Linux-8-Performing_an_advanced_RHEL_installation-en-US.pdf">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/</a></div><div>     <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/pdf/performing_an_advanced_rhel_installation/Red_Hat_Enterprise_Linux-8-Performing_an_advanced_RHEL_installation-en-US.pdf">8/pdf/performing_an_advanced_rhel_installation/Red_Hat_Enterprise_Linux-8-Performing</a></div><div>     <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/pdf/performing_an_advanced_rhel_installation/Red_Hat_Enterprise_Linux-8-Performing_an_advanced_RHEL_installation-en-US.pdf">_an_advanced_RHEL_installation-en-US.pdf</a></div><div><span>     2. </span>CentOS 6.4下PXE+Kickstart无人值守安装操作系统：<br/></div><div><span>     </span><a href="https://www.cnblogs.com/mchina/p/centos-pxe-kickstart-auto-install-os.html">https://www.cnblogs.com/mchina/p/centos-pxe-kickstart-auto-install-os.html</a><br/></div><div><span>     3. CentOS 6.7下</span>Kickstart无人值守安装（老男孩）：<br/></div><div><span>     </span><a href="https://www.zyops.com/autoinstall-kickstart/">https://www.zyops.com/autoinstall-kickstart/</a><br/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P349：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">AUTOMATING INSTALLATION WITH KICKSTART</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第三节：安装和配置虚拟机</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能使用Cockpit在红帽企业Linux服务器上安装虚拟机。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">KVM虚拟化简介：</span></div><ul><li><div>虚拟化允许单个物理计算机分为多个虚拟机（VM），每个虚拟机可以分别运行独立操作系统。</div></li><li><div>RHEL 8支持KVM，它是在Linux内核中内置的完整虚拟化解决方案。</div></li><li><div><span style="font-weight: bold;">在RHEL中，使用virsh命令或Cockpit来管理KVM。</span></div></li></ul><div>     <img src="chapter12_files/Image [9].png" type="image/png" data-filename="Image.png" width="380"/></div><div><br/></div><div><span style="font-weight: bold;">配置RHEL物理系统作为虚拟化主机：</span></div><ul><li><div>为虚拟主机安装 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">virt</span> Yum模块。</div></li></ul><div>     <img src="chapter12_files/Image [10].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <img src="chapter12_files/Image [11].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>使用 <b><i><font style="color: rgb(0, 0, 255);">virt-host-validate</font></i></b> 命令验证系统要求（Intel VT-x 或 AMD-V 64bit）。</div></li></ul><div><span>     </span><img src="chapter12_files/1.JPG" type="image/jpeg" data-filename="1.JPG" width="578"/><br/></div><div><br/></div><div><b>使用Cockpit管理虚拟机：</b></div><ul><li><div>virt Yum模块提供了 <i><b><font style="color: rgb(0, 0, 255);">virsh</font></b></i> 命令来管理虚拟机。</div></li><li><div>Cockpit工具提供了一个Web控制台界面，用于进行KVM管理和虚拟机创建。</div></li></ul><div><span>     </span><img src="chapter12_files/Image [12].png" type="image/png" data-filename="Image.png" width="499"/><br/></div><div><br/></div><ul><li><div>安装 <b><i><font style="color: rgb(0, 0, 255);">cockpit-machines</font></i></b> 软件包，为Cockpit添加 Virtual Machines 菜单。     </div></li></ul><div>     <b>$ yum install -y cockpit-machines</b><br/></div></div><div><span><span>     </span><br/></span></div><ul><li><div>如果Cockpit尚未运行，需将其启动并启用。</div></li></ul><div>     <b>$ systemctl enable --now cockpit.socket</b><br/></div><div><br/></div><ul><li><div>访问Virtual Machines菜单。</div></li><li><div>单击Create VM并在Create New Virtual Machine窗口中输入虚拟机配置。</div></li></ul><div><span>     </span><img src="chapter12_files/Image [13].png" type="image/png" data-filename="Image.png" width="499"/><br/></div><div><br/></div><ul><li><div>单击Create将创建虚拟机，单击Install启动操作系统安装。</div></li></ul><div><span>     * 注意：此处虚拟机创建</span><br/></div><ul><li><div>Cockpit可显示安装系统的虚拟机控制台。</div></li></ul><div><span>     </span><img src="chapter12_files/Image [14].png" type="image/png" data-filename="Image.png" width="498"/><br/></div><div><br/></div><div>    <font color="#FA7A00"><b> 练习 P357：</b><b>INSTALLING AND CONFIGURING VIRTUAL MACHINES</b></font></div><div><b><font color="#FA7A00"><span>     Lab P359：</span>INSTALLING RED HAT ENTERPRISE LINUX</font></b></div><div><br/></div><div><br/></div><div><br/></div></div></span>
</div></body></html> 