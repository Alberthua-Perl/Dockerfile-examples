<html>
<head>
  <title>第八章 实施高级存储功能</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="9026"/>

<div>
<span><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第八章 实施高级存储功能</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>使用stratis本地存储管理系统管理存储，并使用VDO卷优化使用中的存储空间。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>使用stratis管理分层存储</div></li><li><div>使用VDO压缩存储和删除重复数据</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：使用stratis管理分层存储</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能使用stratis本地存储管理系统管理多个存储层。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">描述STRATIS架构：</span></div><ul><li><div>RHEL当前的本地存储解决方案中包含许多成熟、稳定的技术，其中包括设备映射器（dm）、</div></li></ul><div>     逻辑卷管理器（LVM）及XFS文件系统。</div><ul><li><div>这些组件提供的功能包括可大规模扩展的文件系统、快照、冗余（RAID）逻辑设备、多路径、</div></li></ul><div>     精简配置、缓存、重复数据删除，以及对虚拟机和容器的支持。</div><ul><li><div><span style="font-weight: bold;">每个存储堆栈层（dm、LVM和XFS）均使用专门面向层的命令和实用程序进行管理，这就要求</span></div></li></ul><div><span style="font-weight: bold;">     系统管理员将物理设备、固定大小的卷和文件系统作为独立的存储组件进行管理。</span></div><div><br/></div><ul><li><div>近年来出现了新一代的存储管理解决方案，称为卷管理文件系统，它可以在创建文件系统及</div></li></ul><div>     调整其大小时以动态、透明的方式来管理卷层。</div><ul><li><div>不过，尽管这些文件系统的社区开发已经持续了很多年，但仍未达到成为RHEL主要本地存储</div></li></ul><div>     所需的功能支持和稳定性水平。</div><div>     </div><ul><li><div>在RHEL 8中，红帽推出了 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">stratis</span> 存储管理解决方案。</div></li><li><div>与其他存储项目一样，stratis的开发并不是从零开始，而是使用现有的RHEL存储组件。</div></li><li><div>stratis以管理物理存储设备池的服务形式运行，并透明地为所创建的文件系统创建和管理卷。</div></li><li><div><span style="font-weight: bold;">由于stratis使用现有的存储驱动程序和工具，因此stratis也支持当前在LVM、XFS和</span></div></li></ul><div><span style="font-weight: bold;">     device-mapper中使用的所有高级存储功能。</span></div><div>     <img src="chapter8_files/Image.png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>在卷管理文件系统中，文件系统借助精简配置（<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">thin provisioning</span>）的概念内置于磁盘设备</div></li></ul><div>     的共享池中。</div><ul><li><div><span style="font-weight: bold;">stratis文件系统没有固定大小，也不再预分配未使用的块空间。</span></div></li><li><div>尽管文件系统仍构建在隐藏的LVM卷上，但stratis会管理基础卷，并可在需要时对其扩展。</div></li><li><div><span style="font-weight: bold;">文件系统的 “使用中（in-use）” 大小可视作所含文件占用的实际块数量。</span></div></li><li><div><span style="font-weight: bold;">文件系统的可用空间就是它所驻留的池设备中仍未使用的空间量。</span></div></li><li><div>多个文件系统可以驻留在同一磁盘设备池中，共享可用空间，但文件系统也可以保留池空间，</div></li></ul><div>     以便在需要时保证可用性。</div><div><br/></div><ul><li><div>stratis使用存储的元数据来识别所管理的池、卷和文件系统。</div></li><li><div>因此，绝不应该对stratis创建的文件系统进行手动重新格式化或重新配置。</div></li><li><div>只应使用stratis工具和命令对它们进行管理。</div></li><li><div>手动配置stratis文件系统可能会导致该元数据丢失，并阻止stratis识别它已创建的文件系统。</div></li></ul><div><br/></div><ul><li><div>可使用不同组的块设备来创建多个池。</div></li><li><div>在每个池中，可以创建一个或多个文件系统。</div></li><li><div><span style="font-weight: bold;">目前，每个池最多可以创建 224 个文件系统。</span></div></li></ul><div><br/></div><ul><li><div>stratis存储管理解决方案架构：</div></li></ul><div>     <img src="chapter8_files/Image [1].png" type="image/png" data-filename="Image.png" width="446"/></div><div><br/></div><ul><li><div>池可将块设备分组到数据层，或分组到缓存层（可选）。</div></li><li><div>数据层侧重于灵活性和完整性，而缓存层则侧重于提高性能。</div></li><li><div>由于缓存层旨在提高性能，因此应使用具有更高每秒输入/输出操作次数（IOPS）的块设备，</div></li></ul><div>     如SSD。</div><div><br/></div><div><span style="font-weight: bold;">描述简化的存储堆栈：</span></div><ul><li><div>stratis简化了各红帽产品之间本地存储部署和配置的许多方面。</div></li><li><div>使用stratis的产品：Anaconda、Cockpit、红帽虚拟化和红帽企业Linux Atomic主机。</div></li><li><div>对于所有这些产品，stratis令存储空间和快照的管理变得更为简单，且更不容易出错。</div></li><li><div>stratis更容易与高级管理工具进行集成。</div></li></ul><div>     <img src="chapter8_files/Image [2].png" type="image/png" data-filename="Image.png" width="347"/></div><div><br/></div><div><span style="font-weight: bold;">描述Stratis层：</span></div><ul><li><div><span style="font-weight: bold;">在内部，stratis使用</span> <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">Backstore</span> <span style="font-weight: bold;">子系统来管理块设备，并使用</span> <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">Thinpool</span> <span style="font-weight: bold;">子系统来管理池。</span></div></li><li><div>Backstore子系统：</div></li></ul><div>     1. 数据层：负责维护块设备上的元数据，以及检测和纠正数据损坏。</div><div>     2. 缓存层：使用高性能块设备，作为数据层之上的缓存。</div><ul><li><div>Thinpool子系统：</div></li></ul><div>     1. 管理与stratis文件系统关联的精简配置的卷（thin-provisioned volume）。</div><div>     2. 该子系统使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">dm-thin device-mapper</span> 驱动程序取代LVM进行虚拟卷管理。</div><div><br/></div><ul><li><div>dm-thin可以创建虚拟空间比较大、采用XFS格式，但物理空间比较小的卷。</div></li><li><div>当物理空间快满时，stratis会自动将其扩大。</div></li><li><div>stratis分层架构：</div></li></ul><div>     <img src="chapter8_files/Image [3].png" type="image/png" data-filename="Image.png" width="442"/></div><div>     <img src="chapter8_files/Image [4].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       device-mapper存储驱动的用例：thin-provisioned、snapshot</div><div>       <span style="font-weight: bold;">LVM、stratis、vdo、device-mapper-multipath、crypted-image、docker</span></div><div><br/></div><div><span style="font-weight: bold;">管理精简配置的文件系统：thin-provisioned（也称瘦模式）</span></div><ul><li><div>管理精简配置的文件系统，需安装 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">stratis-cli</span> 和 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">stratisd</span> 软件包。</div></li><li><div>stratis-cli软件包中提供了stratis命令，通过 D-Bus API 将用户请求转换为stratisd服务。</div></li><li><div>stratisd软件包中提供了stratisd服务，它实现 D-Bus 接口管理和监控stratis的元素，如</div></li></ul><div>     块设备、池和文件系统。</div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       必须保证dbus.socket与dbus.service处于运行状态，stratis-cli才能与stratisd.service</div><div>       正常通信。</div><div>       <img src="chapter8_files/Image [5].png" type="image/png" data-filename="Image.png" width="562"/> </div><div><br/></div><ul><li><div>安装并激活stratis：</div></li></ul><div>     <span style="font-weight: bold;">$ yum install -y stratis-cli stratisd</span></div><div>     # 安装stratis-cli与stratisd软件包</div><div><br/></div><div>     <span style="font-weight: bold;">$ systemctl enable --now stratisd.service</span></div><div>     # 激活stratisd服务</div><div><br/></div><ul><li><div>使用stratis执行的常见管理操作：</div></li></ul><div>     1. 使用 stratis pool create 命令创建包含一个或多个块设备的池，每个池都是 /stratis</div><div>        下的一个子目录。</div><div>        <img src="chapter8_files/Image [6].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div>     2. 使用 stratis pool list 命令查看可用池的列表。</div><div>        <img src="chapter8_files/Image [7].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div>     3. 使用 stratis pool add-data 命令向池中添加额外的块设备。</div><div>        <img src="chapter8_files/Image [8].png" type="image/png" data-filename="Image.png" width="555"/></div><div><br/></div><div>     4. 使用 stratis blockdev list 命令查看池的块设备。</div><div>        <img src="chapter8_files/Image [9].png" type="image/png" data-filename="Image.png" width="555"/></div><div><br/></div><div>     5. 使用 stratis filesystem create 命令为池创建动态、灵活的文件系统。</div><div>        stratis文件系统的链接位于 /stratis/pool1 目录中。</div><div>        <img src="chapter8_files/Image [10].png" type="image/png" data-filename="Image.png" width="555"/></div><div><br/></div><div>     6. 使用 stratis filesystem snapshot 命令创建文件系统快照。</div><div>        <span style="font-weight: bold;">快照独立于源文件系统。</span></div><div>        <img src="chapter8_files/Image [11].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div>     7. 使用 stratis filesystem list 命令查看可用文件系统的列表。          </div><div>        <img src="chapter8_files/Image [12].png" type="image/png" data-filename="Image.png" width="555"/></div><div><br/></div></div><div>     8. 为了持久挂载stratis文件系统，需编辑/etc/fstab。</div><div>        <img src="chapter8_files/Image [13].png" type="image/png" data-filename="Image.png" width="555"/></div><div>        <img src="chapter8_files/Image [14].png" type="image/png" data-filename="Image.png" width="556"/></div><div>      <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>        1. <span style="font-weight: bold;">x-systemd.requires=stratisd.service</span> 挂载选项可延迟挂载文件系统，直到systemd</div><div>           在启动过程中启动stratisd.service为止。 </div><div>        2. stratis中的设备均由device-mapper存储驱动映射管理。</div><div>        <img src="chapter8_files/stratis文件系统对应的设备由device-mapper存储驱动管理.JPG" type="image/jpeg" data-filename="stratis文件系统对应的设备由device-mapper存储驱动管理.JPG" width="555"/>  </div><div><br/></div><div>   <font style="color: rgb(0, 0, 255);"><b>* </b><b>注意：</b></font></div><div><span>     1. stratisd服务正常，lsblk命令可查看相关stratis设备，但无法使用stratis命令查看stratis</span></div><div><span><span>    </span><span>    </span>设备，输出返回结果为空，并无法删除stratis设备。</span></div><div><span><span>     2. $ dmsetup info /dev/mapper/stratis-*：查看相关stratis设备的状态</span><br/></span></div><div><span>    </span><span>    </span><img src="chapter8_files/微信图片_20200720213440.jpg" type="image/jpeg" data-filename="微信图片_20200720213440.jpg" width="555"/><br/></div><div><br/></div><div>     3. <b><font>当stratis设备为ACTIVE状态时，无法将其删除，需转换为SUSPEND状态。</font></b><br/></div><div><span>     4. <b>$ dmsetup suspend /dev/mapper/stratis-*</b>：设置stratis设备为SUSPEND状态<br/></span></div><div><span><span>     5. $ dmsetup remove /dev/mapper/stratis-*：删除stratis设备</span><br/></span></div><div><span><span>     6. stratis设备全部删除后，使用 lsblk --fs 命令查看磁盘设备时依然显示stratis类型，</span><br/></span></div><div><span><span>    </span><span>    该状态下可直接使用该磁盘设备（分区、格式化与挂载等）。</span><br/></span></div><div>    </div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P223：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">MANAGING LAYERED STORAGE WITH STRATIS</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：使用VDO压缩存储和删除重复数据</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能使用VDO压缩存储设备上的数据并进行重复删除，以此来优化存储空间</div></li></ul><div>     的使用。</div><div><br/></div><div><span style="font-weight: bold;">描述虚拟数据优化器：virtual data optimizer</span></div><ul><li><div>RHEL 8包含虚拟数据优化器（VDO）驱动程序，可以优化块设备上数据的空间占用。</div></li><li><div><span style="font-weight: bold;">VDO是一个Linux设备映射器驱动程序，它可以减少块设备上的磁盘空间使用，同时最大限度减少</span></div></li></ul><div><span style="font-weight: bold;">     数据重复，从而节省磁盘空间，甚至提高数据吞吐量。</span></div><div><br/></div><ul><li><div>VDO的两个内核模块：</div></li></ul><div>     1. <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">kvdo</span> 模块：用于以透明的方式控制数据压缩</div><div>     2. <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">uds</span> 模块：用于重复数据删除</div><div>     <img src="chapter8_files/Image [15].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>VDO层位于块存储设备（如RAID阵列或本地磁盘）的顶部。</div></li><li><div>存储层（如LVM逻辑卷和文件系统）位于VDO设备之上。</div></li></ul><div>     <img src="chapter8_files/Image [16].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><ul><li><div>VDO按以下顺序对数据实施三个阶段的处理，以减少空间占用：</div></li></ul><div>     1. 零块消除将过滤掉仅包含零（0）的数据块，且仅在元数据中记录这些块的信息。</div><div>        非零数据块随即被传递到下一个处理阶段。</div><div>        <span style="font-weight: bold;">该阶段将启用VDO设备中的精简配置（thin provisioned）功能。</span></div><div>     2. 重复数据删除去除冗余的数据块。</div><div>        在创建相同数据的多个副本时，VDO会检测重复数据块并更新元数据，以便使用这些重复块</div><div>        来引用原始数据块，而不会创建冗余数据块。</div><div>        <span style="font-weight: bold;">uds内核模块将通过其维护的元数据来检查数据的冗余。</span></div><div>     3. 最后一个阶段是压缩。</div><div>        <span style="font-weight: bold;">kvdo内核模块使用 LZ4 压缩对块进行压缩，并以</span> <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">4KB</span> <span style="font-weight: bold;">块进行分组。</span></div><div><br/></div><div><span style="font-weight: bold;">实施VDO：</span></div><ul><li><div>利用VDO创建的逻辑设备被称为VDO卷。</div></li><li><div>VDO卷与磁盘分区类似，可以将这些卷格式化为所需的文件系统，并进行挂载。</div></li><li><div><span style="font-weight: bold;">此外，还可以将VDO卷用作LVM物理卷（PV）。</span></div></li></ul><div><br/></div><ul><li><div>要创建VDO卷，需指定块设备和逻辑设备的名称。</div></li><li><div>也可以指定VDO卷的逻辑大小（可选）。</div></li><li><div>VDO卷的逻辑大小可以大于实际块设备的物理大小。</div></li><li><div>由于VDO卷采用了精简配置，因此用户只能看到正在使用的逻辑空间，而无法了解实际可用的</div></li></ul><div>     物理空间。</div><ul><li><div><span style="font-weight: bold;">如果在创建卷时未指定逻辑大小，则VDO会将实际物理大小视为卷的逻辑大小。</span></div></li><li><div><span style="font-weight: bold;">这种采用 1:1 的比率映射方式有利于提高性能，但也会降低存储空间的使用效率。</span></div></li><li><div>应根据基础架构要求来确定是优先考虑性能还是空间效率。</div></li></ul><div><br/></div><ul><li><div><span style="font-weight: bold;">$ vdostats --verbose</span></div></li></ul><div>     # 当VDO卷的逻辑大小超过实际物理大小时，主动监控卷统计信息，以查看实际使用情况。</div><div>     <img src="chapter8_files/Image [17].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div><span style="font-weight: bold;">启用VDO：</span></div><ul><li><div><span style="font-weight: bold;">$ yum install -y vdo kmod-kvdo</span></div></li></ul><div>     # 安装VDO与kmod-kvdo软件包</div><div><br/></div><div><span style="font-weight: bold;">创建VDO卷：</span></div><ul><li><div><span style="font-weight: bold;">$ vdo create \</span></div></li></ul><div><span style="font-weight: bold;">       --name=&lt;</span><span style="font-style: italic; font-weight: bold;">vdo_volume_name</span><span style="font-weight: bold;">&gt; --device=&lt;</span><span style="font-style: italic; font-weight: bold;">device_name</span><span style="font-weight: bold;">&gt; --vdoLogicalSize=&lt;</span><span style="font-style: italic; font-weight: bold;">number</span><span style="font-weight: bold;">&gt;</span></div><div>     # 创建VDO卷     </div><div>     <img src="chapter8_files/Image [18].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ vdo list</span></div><div>     # 查看当前VDO卷的列表</div><div><br/></div><div>     <span style="font-weight: bold;">$ vdo remove --name=&lt;</span><span style="font-style: italic; font-weight: bold;">vdo_volume_name</span><span style="font-weight: bold;">&gt;</span></div><div>     # 删除VDO卷</div><div>     <img src="chapter8_files/Image [19].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">如果省略逻辑大小，则生成的VDO卷将与其物理设备的大小相同。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">分析VDO卷：</span></div><ul><li><div><span style="font-weight: bold;">$ vdo status --name=&lt;</span><span style="font-style: italic; font-weight: bold;">vdo_volume_name</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     # 查看VDO卷的详细信息，结果以YAML格式返回。</div><div>   </div><div><span style="font-weight: bold;">启动与停止VDO卷：</span></div><ul><li><div>默认情况下，VDO卷创建时即已启动。</div></li><li><div><span style="font-weight: bold;">$ vdo stop --name=&lt;</span><span style="font-weight: bold; font-style: italic;">vdo_volume_name</span><span style="font-weight: bold;">&gt; --confFile=/etc/vdoconf.yml</span></div></li></ul><div><span style="font-weight: bold;">     </span># 停止指定的VDO卷</div><div><span style="font-weight: bold;">     </span>$ vdo stop --all --confFile=/etc/vdoconf.yml</div><div>     # 停止所有的VDO卷</div><div><br/></div></div><ul><li><div><span style="font-weight: bold;">$ vdo start --name=&lt;</span><span style="font-weight: bold; font-style: italic;">vdo_volume_name</span><span style="font-weight: bold;">&gt; --confFile=/etc/vdoconf.yml</span></div></li></ul><div><span style="font-weight: bold;">     </span># 启动指定的VDO卷</div><div>     $ vdo start --all --confFile=/etc/vdoconf.yml</div><div>     # 启动所有的VDO卷</div><div><br/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. <span style="font-weight: bold;">VDO卷管理服务由systemd管控，该服务用于启动与停止VDO卷，而非VDO卷守护进程。</span></div><div>       2. 将该服务关闭后，依然可创建VDO卷，而stratisd服务关闭后无法使用stratis。</div><div>       3. <span style="font-weight: bold;">可使用该服务启动或停止所有的VDO卷。 </span></div><div>       <img src="chapter8_files/Image [20].png" type="image/png" data-filename="Image.png" width="562"/></div><div>    </div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P232：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">COMPRESSING AND DEDUPLICATING STORAGE WITH VDO</span></div><div><span style="font-weight: bold; color: rgb(250, 122, 0);">     Lab P236：IMPLEMENTING ADVANCED STORAGE FEATURES</span></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 