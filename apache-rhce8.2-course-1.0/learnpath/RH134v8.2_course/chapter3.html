<html>
<head>
  <title>第三章 调优系统性能</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="8606"/>

<div>
<span><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第三章 调优系统性能</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>通过设置调优参数和调整进程的调度优先级来提高系统性能。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>调整调优配置文件</div></li><li><div>影响进程调度</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：调整调优配置文件</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能通过选择tuned的调优配置文件来优化系统性能。</div></li></ul><div><br/></div></div><div><span style="font-weight: bold;">系统调优：</span></div><ul><li><div>管理员可以基于多种工作负载特征来调整各种设置，以此优化系统性能。</div></li><li><div><span style="font-weight: bold;">tuned守护进程使用反映特定工作负载特征的调优配置文件，以静态和动态两种方式进行调优。</span></div></li></ul><div><br/></div><ul><li><div>配置静态调优：static tuning</div></li></ul><div>     1. tuned守护进程会在服务启动时或选择新的调优配置文件时应用系统设置。</div><div>     2. <span style="font-weight: bold;">静态调优会对配置文件中由tuned在运行时应用的预定义kernel参数进行配置。</span></div><div>     3. 对于静态调优而言，内核参数是针对整体性能预期而设置的，不会随着活跃度的变化而</div><div>        进行调整。</div><div><br/></div><ul><li><div>配置动态调优：dynamic tuning</div></li></ul><div><span style="font-weight: bold;">     </span>1. <span style="font-weight: bold;">对于动态调优而言，tuned守护进程会监视系统活动，并根据运行时行为的变化来调整设置。</span></div><div>     2. 从所选调优配置文件中声明的初始设置开始，动态调优会不断进行调优调整以适应当前工作</div><div>        负载。</div><div><span style="font-weight: bold;">     </span>3. 如，存储设备在启动和登录期间的使用率会比较高，但如果用户工作负载的内容是使用Web</div><div>        浏览器和电子邮件客户端，则活动量会很少。</div><div>     4. 同样，CPU和网络设备在整个工作日的高峰使用期间会出现活动增加的情况。</div><div>     5. tuned守护进程会监视这些组件的活动并调整参数设置，以最大限度提升高活动量期间的</div><div>        性能，并在低活动量期间降低设置值。</div><div>     6. tuned守护进程将使用预定义调优配置文件中提供的性能参数。</div><div><br/></div><div><span style="font-weight: bold;">安装与启用tuned：</span></div><ul><li><div>默认情况下，RHEL 8的最小安装中包含并启用了 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">tuned</span> 软件包。</div></li><li><div>手动安装并启用该软件包：</div></li></ul><div>     <img src="chapter3_files/Image.png" type="image/png" data-filename="Image.png" width="497"/>     </div><div><br/></div><div><span style="font-weight: bold;">选择调优配置文件：tuning profile</span></div><ul><li><div>tuned应用提供的配置文件分为以下类别：</div></li></ul><div>     1. 节能型配置文件（power-saving profiles）</div><div>     2. 性能提升型配置文件（performance-boosting profiles）</div><div><br/></div><ul><li><div>性能提升型配置文件中包括侧重于以下方面：</div></li></ul><div>     1. 存储和网络的低延迟（low latency for storage and network）</div><div>     2. 存储和网络的高吞吐量（high throughput for storage and network）</div><div>     3. 虚拟机性能（virtual machine performance）</div><div>     4. 虚拟化主机性能（virtualization host performance）</div><div><span style="font-weight: bold;">     </span><span style="font-weight: bold;"><img src="chapter3_files/Image [1].png" type="image/png" data-filename="Image.png" width="500"/></span></div><div><br/></div><div><span style="font-weight: bold;">从命令行管理配置文件：</span></div><ul><li><div><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">tuned-adm</span>命令用于更改tuned守护进程的设置。</div></li><li><div>tuned-adm常用命令示例：     </div></li></ul><div>     <span style="font-weight: bold;">$ tuned-adm active</span></div><div>     # 查看当前活动的调优配置文件</div><div>     <img src="chapter3_files/Image [2].png" type="image/png" data-filename="Image.png" width="442"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ tuned-adm list</span></div><div>     # 列出当前可用的调优配置文件</div><div>     # 该结果中包括内置的与系统管理员创建的自定义调优配置文件</div><div>     <img src="chapter3_files/Image [3].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ tuned-adm profile &lt;</span><span style="font-style: italic; font-weight: bold;">profile_name</span><span style="font-weight: bold;">&gt;</span></div><div>     # 切换不同的调优配置文件</div><div>     # 系统在同一时刻只能指定唯一的调优配置文件 </div><div>     <img src="chapter3_files/Image [4].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ tuned-adm recommend</span></div><div>     # 为系统推荐调优配置文件</div><div>     <img src="chapter3_files/Image [5].png" type="image/png" data-filename="Image.png" width="442"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ tuned-adm off</span></div><div>     # 关闭tuned调优活动</div><div>     <img src="chapter3_files/Image [6].png" type="image/png" data-filename="Image.png" width="443"/></div><div><br/></div><div><span style="font-weight: bold;">通过Web Console管理配置文件：</span></div><ul><li><div>要通过Web Console管理系统性能配置文件，需使用具有特权的访问权限登录。</div></li><li><div>只有能正确提权为root权限的用户（sudo列表或wheel组），才能单击 <span style="font-weight: bold;">Reuse my password</span></div></li></ul><div><span style="font-weight: bold;">     for privileged tasks </span>选项，修改系统性能配置文件的命令。</div><div>     <img src="chapter3_files/Image [7].png" type="image/png" data-filename="Image.png" width="578"/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. <span style="font-weight: bold;">wheel组中的用户，或在系统sudo列表中能免密（NOPASSWD）提升为root权限的用户，</span></div><div><span style="font-weight: bold;">          才能使用以上选项在Web Console中执行系统管理员操作。</span></div><div>       2. 无法正确提权为root权限的用户，即使使用以上选项，依然不能执行系统管理员操作！ </div><div>       3. 在sudo列表中只能部分免密的用户也不能执行管理员操作。</div><div>       <img src="chapter3_files/Image [8].png" type="image/png" data-filename="Image.png" width="563"/> </div><div>           </div><ul><li><div>以特权用户的身份单击左侧导航栏中的 Systems 菜单选项。</div></li><li><div>当前活动的配置文件将显示在 <span style="font-weight: bold;">Performance Profile</span> 字段中。</div></li><li><div>要选择其他配置文件，单击活动配置文件链接。</div></li></ul><div>     <img src="chapter3_files/Image [9].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>在 Change Performance Profile 界面中，滚动配置文件列表以选择最适合系统用途的配置文件。</div></li></ul><div>     <img src="chapter3_files/Image [10].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><ul><li><div>验证更改，返回主 System 页面并确认 Performance Profile 字段中是否显示活动的配置文件。</div></li></ul><div>     <img src="chapter3_files/Image [11].png" type="image/png" data-filename="Image.png" width="579"/></div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>     RHEL 8中可使用Cockpit的Web Console实现系统管理，该服务监听9090端口。</div><div>     <img src="chapter3_files/Image [12].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P73：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">ADJUSTING TUNING PROFILES</span></div><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">第二节：影响进程调度</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能通过nice和renice命令对特定进程进行优先排序或取消其优先排序。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">Linux进程调度和多任务：process scheduling</span></div><ul><li><div>现代计算机系统有一个共同点，即需要运行的进程及线程数量超出了其CPU数量。</div></li><li><div>通过使用称为时间片（<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">time-slicing</span>）或多任务（<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">multitasking</span>）的技术，Linux和其他</div></li></ul><div>     操作系统可运行超出其处理单元数的进程。</div><ul><li><div><span style="font-weight: bold;">操作系统进程调度程序在单个核心上的进程之间快速切换，从而给人一种有多个进程在同时</span></div></li></ul><div><span style="font-weight: bold;">     运行的印象。</span></div><div><br/></div><div><span style="font-weight: bold;">相对优先级：relative priorities </span></div><ul><li><div>可以设置针对不同的进程，采用不同的调度策略。</div></li><li><div>系统上运行的大多数进程所使用的调度策略（scheduling policies）称为 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">SCHED_OTHER</span></div></li></ul><div>     （也称为 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">SCHED_NORMAL</span>）。</div><ul><li><div><span style="font-weight: bold;">可为采用SCHED_NORMAL策略运行的进程指定相对优先级，优先级称为 nice 值。</span></div></li><li><div>对于任何进程，有 40 种不同级别的 nice 值可以设置。</div></li><li><div>nice值的范围介于 -20（最高优先级）到 19（最低优先级）之间。</div></li><li><div><span style="font-weight: bold;">默认情况下，进程将继承其父进程的nice值，通常为 0。</span></div></li><li><div>nice值越高，表示优先级越低（该进程容易将其CPU使用量让给其他进程）。</div></li><li><div>nice值越低，表示优先级越高（该进程更加不倾向于让出CPU）。</div></li><li><div><b>如果不存在资源争用，如当活动进程数少于可用CPU核心数时，即使nice值高的进程也将仍</b></div></li></ul><div><b>     使用尽可能多CPU资源。</b></div><div><br/></div><div><span style="font-weight: bold;">设置nice值和权限：</span></div><ul><li><div>只有root用户可以降低进程的nice值（提高优先级）。</div></li><li><div>普通用户的权限仅限于提高自己进程的nice值，不能降低自己进程的nice值。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">使用top查看nice值：</span></div><ul><li><div><span style="font-weight: bold;">top命令可通过交互方式查看和管理进程，可以查看nice值（NI）和 priority 值（PR）。</span></div></li><li><div>nice值 -20 映射至 PR 值 0。     </div></li></ul><div>     <img src="chapter3_files/Image [13].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div><span style="font-weight: bold;">通过命令显示nice值：</span></div><ul><li><div><span style="font-weight: bold;">ps命令可显示进程的nice值。</span></div></li><li><div>以下ps命令列出所有进程，包括其PID、进程名称、nice级别和调度类型，按nice降序排列。</div></li><li><div>在CLS调度类型这一列中显示<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">TS</span>的进程将依照 SCHED_NORMAL 调度策略运行。</div></li><li><div><span style="font-weight: bold;">nice显示为短划线（-）的进程将依照其他调度策略运行，具有较高的优先级。</span></div></li></ul><div>     <img src="chapter3_files/Image [14].png" type="image/png" data-filename="Image.png" width="441"/></div><div><br/></div><div><span style="font-weight: bold;">启动具有不同nice值的进程：</span></div><ul><li><div>在进程创建过程中，进程会继承父级nice值。</div></li><li><div><span style="font-weight: bold;">从命令行启动进程时，进程将从启动它的shell进程那里继承nice值，通常nice值为 0。</span></div></li></ul><div>     <img src="chapter3_files/Image [15].png" type="image/png" data-filename="Image.png" width="443"/></div><div><br/></div><ul><li><div>所有用户都可以使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">nice</span> 命令来启动具有默认或更高nice值的命令，默认为 10。</div></li><li><div><span style="font-weight: bold;">-n 选项可以设置特定nice值。</span></div></li></ul><div>     <span style="font-weight: bold;">$ nice -n &lt;</span><span style="font-style: italic; font-weight: bold;">num</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">command</span><span style="font-weight: bold;">&gt;</span>：指定nice级别创建新进程</div><div>     <img src="chapter3_files/Image [16].png" type="image/png" data-filename="Image.png" width="442"/>     </div><div><br/></div><div><span style="font-weight: bold;">更改现有进程的nice级别：</span></div><ul><li><div>使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">renice</span> 命令来更改现有进程的nice级别。</div></li><li><div><span style="font-weight: bold;">$ renice -n &lt;</span><span style="font-style: italic; font-weight: bold;">num</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">pid</span><span style="font-weight: bold;">&gt;</span>：指定nice级别更改现有进程</div></li></ul><div>     <img src="chapter3_files/Image [17].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>也可以使用top命令更改进程的nice级别。</div></li><li><div><span style="font-weight: bold;">在top交互式界面中，按 r 键以访问 renice 命令，后跟要更改的PID和新的nice级别。</span></div></li></ul><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P79：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">INFLUENCING PROCESS SCHEDULING</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P83：TUNING SYSTEM PERFORMANCE</span></div></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 