<html>
<head>
  <title>第九章 访问网络附加存储</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="9128"/>

<div>
<span><div><div><div><div><font style="font-size: 12pt;"><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第九章 访问网络附加存储</span></font></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>使用NFS协议访问网络附加存储。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>通过NFS挂载网络附加存储</div></li><li><div>自动挂载网络附加存储</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：通过NFS挂载网络附加存储</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  识别NFS共享信息。</div></li><li><div>  创建要用作挂载点的目录。</div></li><li><div>  使用mount命令或通过配置/etc/fstab文件来挂载NFS共享。</div></li><li><div>  使用umount命令卸载NFS共享。</div></li><li><div>  借助新的nfsconf工具，配置NFS客户端以使用NFSv4。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">挂载和卸载NFS共享：</span></div><ul><li><div>NFS（网络文件系统）是由Linux、UNIX及类似操作系统使用的互联网标准协议，可作为它们</div></li></ul><div>     的本地网络文件系统。</div><ul><li><div>它是一种仍在积极增强的开放标准，可支持本地Linux权限和文件系统功能。</div></li></ul><div><br/></div><ul><li><div><span style="font-weight: bold;">RHEL 8中的默认NFS版本为</span> <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">4.2</span><span style="font-weight: bold;">。</span></div></li><li><div><span style="font-weight: bold;">支持 NFSv4 和 NFSv3 的主要版本。</span></div></li><li><div>NFSv2 已不再受支持。</div></li><li><div><span style="font-weight: bold;">NFSv4 仅使用 TCP 协议与服务器进行通信，较早的NFS版本可使用TCP或UDP。</span></div></li></ul><div><br/></div><ul><li><div>NFS服务器导出共享（目录）。</div></li><li><div>NFS客户端将导出的共享挂载到本地挂载点（目录），该挂载点必须存在。</div></li></ul><div><br/></div><ul><li><div>可以通过多种方式挂载NFS共享：</div></li></ul><div>     1. 使用mount命令手动挂载</div><div>     2. 使用/etc/fstab条目在启动时自动挂载</div><div>     3. 按需挂载：使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">autofs</span> 服务或 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">systemd.automount</span> 功能</div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div><span style="font-weight: bold;">     </span>1. NAS存储中使用的NFS协议示例：</div><div>     <img src="chapter9_files/NAS网关连接SAN存储架构.jpg" type="image/jpeg" data-filename="NAS网关连接SAN存储架构.jpg" width="211"/> <img src="chapter9_files/NFS架构（NFS机头实现）.jpg" type="image/jpeg" data-filename="NFS架构（NFS机头实现）.jpg" width="304"/> </div><div><br/></div><div><br/></div><div>     2. 常见的数据存储方式比较：<span style="font-weight: bold;">DAS/NAS/SAN</span></div><div>     <img src="chapter9_files/NAS与SAN对比.png" type="image/png" data-filename="NAS与SAN对比.png" width="497"/> </div><div>     <img src="chapter9_files/存储架构差异比较.JPG" type="image/jpeg" data-filename="存储架构差异比较.JPG" width="445"/></div><div><br/></div><div>     3. <span style="font-weight: bold;">NFS客户端与服务端通信过程：RPC（远程过程调用）</span></div><div>     <img src="chapter9_files/NFS架构.png" type="image/png" data-filename="NFS架构.png" width="441"/></div><div>    </div><div><span style="font-weight: bold;">挂载NFS共享：</span></div><ul><li><div>识别：NFS客户端管理员可以通过各种方式识别可用的NFS共享。</div></li><li><div>挂载点：使用mkdir命令在合适的位置创建挂载点。</div></li><li><div>挂载：NFS共享必须以root身份先进行挂载才可用。</div></li></ul><div>     1. 临时挂载：使用 mount 命令挂载NFS共享</div><div>        <img src="chapter9_files/Image.png" type="image/png" data-filename="Image.png" width="475"/></div><div>     2. 永久挂载：编辑/etc/fstab文件以添加挂载条目</div><div>        <img src="chapter9_files/Image [1].png" type="image/png" data-filename="Image.png" width="475"/></div><div><br/></div><div><span style="font-weight: bold;">卸载NFS共享：</span></div><ul><li><div>以root用户身份（或使用sudo），使用 umount 命令卸载NFS共享。</div></li></ul><div>     <img src="chapter9_files/Image [2].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">nfsconf工具：</span></div><ul><li><div>RHEL 8引入了 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">nfsconf</span> 工具，用于管理 NFSv4 与 NFSv3 下的NFS客户端和服务器配置文件。</div></li><li><div>nfsconf工具使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">/etc/nfs.conf</span>（不再使用/etc/sysconfig/nfs）。</div></li><li><div>/etc/nfs.conf由多个部分组成，开头是位于方括号中的关键字（[<span style="font-style: italic;">keyword</span>]）。</div></li><li><div>对于NFS服务器，配置 [nfsd] 部分，由值的名称、等号和值组成，如 vers4.2=y。</div></li><li><div>&quot;#&quot; 或 &quot;;&quot; 开头的行被注释。</div></li></ul><div><br/></div></div><ul><li><div>$ vim /etc/nfs.conf</div></li></ul><div>     <img src="chapter9_files/Image [3].png" type="image/png" data-filename="Image.png" width="382"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ nfsconf --set &lt;</span><span style="font-style: italic; font-weight: bold;">section</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">key</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">value</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     # 设置指定部分中的键值对</div><div>     <span style="font-weight: bold;">$ nfsconf --get &lt;</span><span style="font-style: italic; font-weight: bold;">section</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">key</span><span style="font-weight: bold;">&gt;</span></div><div>     # 查看指定部分中的键值</div><div>     <img src="chapter9_files/Image [4].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ nfsconf --unset &lt;</span><span style="font-style: italic; font-weight: bold;">section</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">key</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     # 取消指定部分中的键值</div><div><br/></div><div><span style="font-weight: bold;">配置一个仅使用NFSv4的客户端：</span></div><ul><li><div>首先禁用 UDP 及与 NFSv2 和 NFSv3 有关的键。</div></li></ul><div>     <span style="font-weight: bold;">$ nfsconf --set nfsd udp n</span></div><div>     $ nfsconf --set nfsd vers2 n</div><div>     $ nfsconf --set nfsd vers3 n</div><div> </div><ul><li><div>启用 TCP 和 NFSv4 相关的键。</div></li></ul><div>     <span style="font-weight: bold;">$ nfsconf --set nfsd tcp y</span></div><div>     $ nfsconf --set nfsd vers4 y</div><div>     $ nfsconf --set nfsd vers4.0 y</div><div>     $ nfsconf --set nfsd vers4.1 y</div><div>     $ nfsconf --set nfsd vers4.2 y    </div><div><br/></div><ul><li><div>/etc/nfs.conf配置文件中会显示所做的更改。</div></li></ul><div>     <img src="chapter9_files/Image [5].png" type="image/png" data-filename="Image.png" width="383"/></div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>     1. $ man 8 mount.nfs：查看mount.nfs命令的使用方法</div><div>     2. $ man 5 nfs.conf：查看NFS守护进程与工具配置</div><div>     3. <span style="font-weight: bold;">$ man 5 nfs</span>：查看挂载NFS时使用的选项信息</div><div><br/></div><div>     4. NFSv4服务端与客户端showmount导出报错：</div><div>        a. NFSv4服务端配置：</div><div>        <img src="chapter9_files/NFSv4服务端配置.JPG" type="image/jpeg" data-filename="NFSv4服务端配置.JPG" width="555"/>    </div><div>        <img src="chapter9_files/Image [6].png" type="image/png" data-filename="Image.png" width="252"/></div><div>    </div><div>        b. NFSv4服务端与客户端查看报错：服务端与客户端必须都有支持的NFS版本</div><div>        <img src="chapter9_files/NFSv4服务端报错.JPG" type="image/jpeg" data-filename="NFSv4服务端报错.JPG" width="419"/></div><div>        <img src="chapter9_files/NFSv4客户端挂载报错.JPG" type="image/jpeg" data-filename="NFSv4客户端挂载报错.JPG" width="554"/></div><div><br/></div><div>        c. 报错原因：</div><div>           showmount命令只能支持NFSv2与NFSv3版本，可同时开启NFSv3与v4的支持以使用该命令。</div><div>        <img src="chapter9_files/Image [7].png" type="image/png" data-filename="Image.png" width="554"/></div><div><br/></div><div>     5. NFS客户端与服务端NFS协议不一致报错：</div><div>     <img src="chapter9_files/NFS版本不一致造成挂载失败.JPG" type="image/jpeg" data-filename="NFS版本不一致造成挂载失败.JPG" width="578"/></div><div>     </div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P253：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">MANAGING NETWORK-ATTACHED STORAGE WITH NFS</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：自动挂载网络附加存储</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  描述使用自动挂载器的优势。</div></li><li><div>  使用直接映射和间接映射（包括通配符）自动挂载NFS共享。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">使用自动挂载器挂载NFS共享：</span></div><ul><li><div>自动挂载器是一个服务（<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">autofs</span>），它可以 “根据需要” 自动挂载NFS共享，并在不再使用</div></li></ul><div>     NFS共享时自动卸载这些共享。</div><ul><li><div>自动挂载器的优势：</div></li></ul><div>     1. 无需root特权就可以运行mount和umount命令。</div><div>     2. autofs中配置的NFS共享可供所有用户使用，受访问权限约束。</div><div>     3. <span style="font-weight: bold;">不需要永久连接，可释放网络和系统资源。</span></div><div>     4. <span style="font-weight: bold;">autofs在客户端配置，无需在服务器端配置。</span></div><div>     5. autofs与mount命令使用相同的选项，包括安全性选项。</div><div>     6. autofs支持直接和间接挂载点映射。</div><div>     7. autofs可创建和删除间接挂载点，从而避免了手动管理。</div><div>     8. <span style="font-weight: bold;">autofs默认网络文件系统是NFS，也可以自动挂载其他网络文件系统。</span></div><div>     9. autofs是一种系统服务。</div><div><br/></div><div><span style="font-weight: bold;">创建自动挂载：</span></div><ul><li><div><span style="font-weight: bold;">$ yum install -y autofs</span></div></li></ul><div>     # 安装autofs软件包</div><div>     </div><ul><li><div>向 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">/etc/auto.master.d</span> 添加一个主映射文件。</div></li><li><div>此文件用于确定挂载点的基础目录，并确定用于创建自动挂载的映射文件。</div></li></ul><div>     <img src="chapter9_files/Image [8].png" type="image/png" data-filename="Image.png" width="498"/></div></div><div><span style="font-weight: bold;">     </span>1. <span style="font-weight: bold;">主映射文件的名称是任意的，但为了让子系统能够识别，必须以 .autofs 作为扩展名。</span></div><div>     2. 可以在一个主映射文件中放置多个条目。</div><div>     3. 或者可以创建多个主映射文件，且每个文件的条目都进行逻辑分组。</div><div><br/></div><div>     4. 此条目将使用/shares目录作为间接自动挂载的基础目录。</div><div>     5. /etc/auto.demo文件中包含挂载详细信息，需使用绝对文件名。</div><div>     6. 需要在启动autofs服务之前创建 auto.demo 文件。</div><div>     <img src="chapter9_files/Image [9].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>创建映射文件。</div></li><li><div><span style="font-weight: bold;">每个映射文件确定一组自动挂载的挂载点、挂载选项及挂载的源位置。</span></div></li><li><div>映射文件的命名规则：<span style="color: rgb(0, 0, 255); font-weight: bold;">/etc/auto.&lt;</span><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">name</span><span style="color: rgb(0, 0, 255); font-weight: bold;">&gt;</span>，其中 <span style="font-style: italic;">name</span> 反映了映射内容。</div></li><li><div>条目的格式：挂载点、挂载选项、源位置。</div></li></ul><div>     <img src="chapter9_files/Image [10].png" type="image/png" data-filename="Image.png" width="499"/></div><div>     <img src="chapter9_files/Image [11].png" type="image/png" data-filename="Image.png" width="499"/>        </div><div><br/></div><div>     1. 此示例显示基本的间接映射条目。</div><div>     2. 本节稍后部分将讨论直接映射和使用通配符的间接映射。</div><div>     3. 挂载点在 man page 中被称为 “密钥（key）”，它由autofs服务自动创建和删除。</div><div>     4. 在此例中，完全限定挂载点是/shares/work（参阅主映射文件）。</div><div>     5. autofs服务将根据需要创建和删除/shares目录和/shares/work目录。</div><div>     </div><div>     6. <span style="font-weight: bold;">挂载选项以短划线字符（-）开头，并使用逗号分隔，不带空格。</span></div><div>     7. 自动挂载时，可以使用相应的挂载选项来手动挂载文件系统。</div><div>     8. 在此例中，自动挂载器将挂载具有读/写访问权限的共享内容（rw选项），并且在写入</div><div>        操作期间服务器会立即同步（sync选项）。</div><div>     9. 有用的自动挂载器特定选项包括：<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">-fstype=</span> 、<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">-strict</span>。</div><div>    10. 使用 fstype 指定文件系统类型，如 nfs4 或 xfs。</div><div>    11. 挂载文件系统时，使用 strict 可将错误视为严重。</div><div><br/></div><div><span style="font-weight: bold;">   </span> 12. NFS共享的源位置遵循 <span style="font-style: italic;">host</span>:/<span style="font-style: italic;">pathname</span> 模式，在此示例中为serverb:/shares/work。</div><div>    13. 为了确保此次自动挂载成功，NFS服务器serverb必须以读/写访问权限导出目录，而请求</div><div>        访问的用户必须对该目录具有标准Linux文件权限。</div><div>    14. <span style="font-weight: bold;">若serverb以只读访问权限导出目录，那么客户端也仅获得只读访问权限，即使它要求读/写</span></div><div><span style="font-weight: bold;">        访问权限。</span></div><div><br/></div><ul><li><div>启动并启用自动挂载器服务。</div></li></ul><div>     <img src="chapter9_files/Image [12].png" type="image/png" data-filename="Image.png" width="579"/></div><div><br/></div><div><span style="font-weight: bold;">直接映射：direct maps</span></div><ul><li><div>直接映射用于将NFS共享映射到现有的绝对路径挂载点。</div></li><li><div>主映射文件如下所示：</div></li></ul><div>     <img src="chapter9_files/Image [13].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">所有直接映射条目都使用</span> <span style="color: rgb(0, 0, 255); font-weight: bold;">/-</span> <span style="font-weight: bold;">作为基础目录</span>。</div></li><li><div>/etc/auto.direct文件的内容如下所示：</div></li></ul><div>     <img src="chapter9_files/Image [14].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">挂载点始终为绝对路径。</span></div></li><li><div>本例中autofs服务将自动创建和删除整个/mnt/docs目录。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">间接通配符映射：indirect wildcard maps</span></div><ul><li><div>当NFS服务器导出一个目录中的多个子目录时，可将自动挂载程序配置为使用单个映射条目访问</div></li></ul><div>     这些子目录其中的任何一个。</div><ul><li><div>若serverb:/shares导出两个或多个子目录，并且能够使用相同的挂载选项访问这些子目录，</div></li></ul><div>     则/etc/auto.demo文件的内容如下所示：</div><div>     <img src="chapter9_files/Image [15].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">挂载点（或密钥）是星号字符（*），而源位置上的子目录是 &amp; 符号。</span></div></li><li><div>条目中的所有其他内容都相同。</div></li><li><div>当用户尝试访问/shares/work时，密钥 *（此例中为work）将代替源位置中的 &amp; 符号，并</div></li></ul><div>     挂载serverb:/shares/work。</div><ul><li><div>对于间接示例，autofs将自动创建和删除work目录。</div></li></ul><div><span style="font-weight: bold;">     </span></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* </span><span style="color: rgb(0, 0, 255); font-weight: bold;">注意：</span></div><div>     1. autofs常用man手册：autofs、automount、auto.master</div><div>     2. 客户端使用autofs自动挂载NFS：直接与间接映射</div><div>     <img src="chapter9_files/autofs的直接与间接映射挂载.JPG" type="image/jpeg" data-filename="autofs的直接与间接映射挂载.JPG" width="577"/></div><div>     <img src="chapter9_files/NFS客户端使用autofs实现自动挂载.JPG" type="image/jpeg" data-filename="NFS客户端使用autofs实现自动挂载.JPG" width="577"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P260：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">AUTOMOUNTING NETWORK-ATTACHED STORAGE</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P266：ACCESSING NETWORK-ATTACHED STORAGE</span></div><div><br/></div></div><div><br/></div><div><br/></div></span>
</div></body></html> 