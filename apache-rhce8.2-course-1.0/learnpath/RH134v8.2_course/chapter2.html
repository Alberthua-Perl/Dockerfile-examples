<html>
<head>
  <title>第二章 计划将来的任务</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="8502"/>

<div>
<span><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第二章 计划将来的任务</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>规划任务以便在将来自动执行。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>计划延迟的用户作业</div></li><li><div>计划周期性用户作业</div></li><li><div>计划周期性系统作业</div></li><li><div>管理临时文件</div></li></ul><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">第一节：计划延迟的用户作业</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能设置一个在将来某个时刻运行一次的命令。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">描述延迟的用户任务：</span></div><ul><li><div>计划好运行的命令被称为任务或作业（task or job）。</div></li><li><div><span style="font-weight: bold;">at软件包包含atd守护进程和一组命令（at、atq等）。</span></div></li><li><div>在默认的RHEL安装过程中，将自动安装并启用atd守护进程。</div></li><li><div>root及普通用户可以使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">at</span> 命令创建计划任务，<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">atd</span> 守护进程提供 a-z 共26个队列，按</div></li></ul><div>     字母排序，越后面的队列优先级越低。</div><div><br/></div><div><span style="font-weight: bold;">计划延迟的用户任务：</span></div><ul><li><div>使用 at &lt;<span style="font-style: italic;">time_spec</span>&gt; 创建作业，at从标准输入中读取指令，直至 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">Ctrl+D</span> 终止。</div></li><li><div>$ at now +5min <span style="font-family: &quot;DejaVu Sans Mono&quot;;">&lt;</span> &lt;<span style="font-style: italic;">script_name</span>&gt;：从脚本导入指令至at中</div></li><li><div>TIMESPEC非常灵活，可参考/usr/share/doc/at/timespec。</div></li></ul><div>     1. now +5min</div><div>     2. teatime tomorrow（下午16:00）</div><div>     3. noon +4 days</div><div>     4. 5pm august 3 2021</div><div>     <img src="chapter2_files/Image.png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">查看和管理延迟的用户作业：</span></div><ul><li><div>使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">atq</span> 或 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">at -l</span> 命令查看用户的待处理作业。</div></li></ul><div>     <img src="chapter2_files/Image [1].png" type="image/png" data-filename="Image.png" width="498"/></div><div>     <img src="chapter2_files/Image [2].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>普通用户只能查看和控制自己的作业。</div></li><li><div>root用户可以查看和管理所有作业。</div></li><li><div><span style="font-weight: bold;">$ at -c &lt;</span><span style="font-style: italic; font-weight: bold;">job_number</span><span style="font-weight: bold;">&gt;</span>：查看作业的详细信息</div></li></ul><div><br/></div><div><span style="font-weight: bold;">删除作业：</span></div><ul><li><div><span style="font-weight: bold;">$ atrm &lt;</span><span style="font-style: italic; font-weight: bold;">job_number</span><span style="font-weight: bold;">&gt;</span>：删除计划作业</div></li></ul><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P38：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">SCHEDULING A DEFERRED USER JOB</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：计划周期性用户作业</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能利用用户的crontab文件来安排命令按计划重复运行。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">描述周期性用户作业：</span></div><ul><li><div>按计划重复运行的作业被称为周期性作业。</div></li><li><div><span style="font-weight: bold;">crond守护进程管理周期性作业，由cronie软件包提供，默认安装并启动。</span></div></li><li><div>crond守护进程读取多个配置文件，crontab命令编辑配置文件。</div></li><li><div><span style="font-weight: bold;">如果计划任务运行失败，crond会发送邮件给指定用户。</span></div></li></ul><div>     <img src="chapter2_files/Image [3].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div><span style="font-weight: bold;">计划周期性用户作业：</span></div><ul><li><div>如下所示：</div></li></ul><div>     <img src="chapter2_files/Image [4].png" type="image/png" data-filename="Image.png" width="499"/>         </div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. crontab命令使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">-u</span> 选项，以此来管理其他用户的作业。</div><div>       2. 不推荐crontab命令来管理系统作业，而应使用下一节中介绍的方法。</div><div><br/></div><div><span style="font-weight: bold;">描述用户作业格式：</span></div><ul><li><div>crontab -e 调用Vim进行计划任务的编辑，每行一个作业，支持空行和 # 注释行。</div></li><li><div><span style="font-weight: bold;">crontab的字段格式：分钟、小时、日、月、星期几、命令（分时日月周）</span></div></li><li><div>其中日和星期是或的关系。</div></li><li><div>前五个字段全部使用相同的语法规则：</div></li></ul><div>     1. * ：始终</div><div>     2. 数字：指定分钟数或小时数、日期或者工作日</div><div>     3. <span style="font-weight: bold;">x-y</span>：范围，x 到 y（含）。</div><div>     4. x,y：列表，列表也可以包含范围。</div><div>     5. <span style="font-weight: bold;">*/x：x的时间间隔</span></div><div><br/></div><div><span style="font-weight: bold;">周期性用户作业示例：</span></div><ul><li><div>每年 2 月 2 日上午 9 点准点执行命令/usr/local/bin/yearly_backup。</div></li></ul><div>     <img src="chapter2_files/Image [5].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div>七月每周五的上午 9 点和下午 4 点间，每五分钟向该作业的所有者发送包含单词Chime</div></li></ul><div>     的电子邮件。</div><div>     <img src="chapter2_files/Image [6].png" type="image/png" data-filename="Image.png" width="499"/>     </div><div><br/></div><ul><li><div>每个工作日（周一到周五）上午 9 点执行mutt命令，从而将邮件消息Checking in发送给</div></li></ul><div>     收件人<a href="mailto:boss@example.com">boss@example.com</a>。</div><div>     <img src="chapter2_files/Image [7].png" type="image/png" data-filename="Image.png" width="499"/></div></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P45：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">SCHEDULING RECURRING USER JOBS</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第三节：计划周期性系统作业</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能在系统crontab文件和目录中，设置命令重复运行的计划任务。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">描述周期性系统作业：</span></div><ul><li><div>系统范围的crontab文件与用户的crontab类似，唯一的不同是系统范围的crontab文件</div></li></ul><div>     的命令字段前面有一个额外用户字段。</div><div>     <img src="chapter2_files/Image [8].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">周期性系统作业应始终在/etc/cron.d目录下创建自定义crontab文件。</span></div></li><li><div>crontab系统中还包含需要每小时、每天、每周和每月运行的脚本目录。</div></li><li><div>这些目录中包含可执行的shell脚本（需添加可执行权限）。</div></li><li><div>存储目录如下所示：</div></li></ul><div>     /etc/cron.hourly/、/etc/cron.daily/、/etc/cron.weekly/、/etc/cron.monthly/</div><div><br/></div><ul><li><div><span style="font-weight: bold;">/etc/cron.d/0hourly 文件调用 run-parts 命令运行/etc/cron.hourly/*脚本。</span></div></li></ul><div><span style="font-weight: bold;">     </span><span style="font-weight: bold;"><img src="chapter2_files/Image [9].png" type="image/png" data-filename="Image.png" width="577"/></span></div><div><br/></div><ul><li><div>/etc/anacrontab文件调用 run-parts 命令运行每日、每周和每月的作业。</div></li><li><div><span style="font-weight: bold;">/etc/anacrontab确保重要的作业始终运行，不会因为系统在应执行作业时关闭或休眠而</span></div></li></ul><div><span style="font-weight: bold;">     意外跳过。</span></div><ul><li><div>如果由于系统重启而导致某个每日运行的系统作业上次未按时执行，则在系统启动后就会执行</div></li></ul><div>     此作业。</div><ul><li><div>但启动作业可能会有几分钟的延迟，参考/etc/anacrontab中 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">Delay in minutes </span>参数值。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">systemd timer简介：</span></div><ul><li><div>随着systemd的出现，RHEL 7开始启用了新的调度功能，即systemd timer unit（定时器单元）。</div></li><li><div><span style="font-weight: bold;">systemd timer unit激活另一个unit，一般是与timer unit同名的service unit。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">timer unit举例：</span></div><ul><li><div>由sysstat软件包提供的sysstat-collect.timer每隔10分钟收集系统统计信息。</div></li><li><div>如下所示：<span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">/usr/lib/systemd/system/sysstat-collect.timer</span></div></li></ul><div>     <img src="chapter2_files/Image [10].png" type="image/png" data-filename="Image.png" width="578"/>     </div><div><br/></div><ul><li><div>OnCalendar定义了时间间隔，表示方法很灵活。</div></li><li><div>如，2019-03-* 12:35,37,39:16 表示2019年3月每一天的12:35:16、12:37:16和12:39:16。</div></li><li><div>也可使用OnUnitActiveSec，如，OnUnitActiveSec=15min表示每隔15分钟激活。</div></li></ul><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* </span><span style="color: rgb(0, 0, 255); font-weight: bold;">注意：</span></div><div>       1. 请不要修改 /usr/lib/systemd/system 中配置文件，应该拷贝到 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">/etc/systemd/system</span></div><div>          中并修改，以防因为软件包的更新被覆盖。</div><div>       2. 更改systemd配置后，使用 systemctl daemon-reload 让systemd重新加载配置。</div><div>          <img src="chapter2_files/Image [11].png" type="image/png" data-filename="Image.png" width="540"/></div><div>       3. 重新加载后，需要使用systemctl激活timer unit。</div><div>          <img src="chapter2_files/Image [12].png" type="image/png" data-filename="Image.png" width="538"/></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">    </span><span style="color: rgb(250, 122, 0); font-weight: bold;"> </span>  4. 常用man帮助手册：</div><div>          $ man 5 crontab</div><div>          <span style="font-weight: bold;">$ man 8 anacron</span></div><div>          $ man 5 anacrontab</div><div>          <span style="font-weight: bold;">$ man 7 systemd.time</span></div><div><span style="font-weight: bold;">          $ man 5 systemd.timer</span></div><div>          $ man 8 crond  </div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">    </span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     练习 P51：SCHEDULING RECURRING SYSTEM JOBS</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第四节：管理临时文件</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能启用和禁用systemd timer并配置管理临时文件的timer。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">管理临时文件：temporary file</span></div><ul><li><div>有些应用（和用户）会使用 /tmp 目录来保存临时数据。</div></li><li><div>还有一些应用（和用户）则使用特定位置，如 /run 下特定易失性目录。</div></li><li><div><span style="font-weight: bold;">系统重新启动或断电时，易失性存储器的所有内容都会丢失。</span></div></li></ul><div><br/></div><ul><li><div>为保持系统充分运行，有必要创建这些不存在的目录和文件，因为守护进程和脚本可能会依靠</div></li></ul><div>     它们的存在。</div><ul><li><div>RHEL 7及更高版本中包含了一个名为 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">systemd-tmpfiles</span> 的新工具，它提供了一种结构化和</div></li></ul><div>     可配置的方法来管理临时目录和文件。</div><ul><li><div>在systemd启动系统后，其中一个最先启动的service unit是 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">systemd-tmpfiles-setup</span>。</div></li><li><div>该服务运行 systemd-tmpfiles --create --remove 命令。</div></li></ul><div>     <img src="chapter2_files/Image [13].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><ul><li><div>此命令从以下目录读取配置文件：</div></li></ul><div>     /usr/lib/tmpfiles.d/*.conf</div><div>     /run/tmpfiles.d/*.conf</div><div>     /etc/tmpfiles.d/*.conf</div><div><br/></div><ul><li><div><span style="font-weight: bold;">系统会删除这些配置文件中标记要删除的文件和目录，并且会创建标记要创建（或修复权限）</span></div></li></ul><div><span style="font-weight: bold;">     的文件和目录，并使其拥有正确的权限（如有必要）。</span></div><div><br/></div><div><span style="font-weight: bold;">使用systemd timer清理临时文件：</span></div><ul><li><div>为确保长期运行的系统不会用陈旧数据填满磁盘，名为 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">systemd-tmpfiles-clean.timer</span> 的</div></li></ul><div>     systemd timer unit会定期触发 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">systemd-tmpfiles-clean.service</span> 来执行systemd-tmpfiles </div><div>     --clean命令。</div><div>     <img src="chapter2_files/Image [14].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <img src="chapter2_files/Image [15].png" type="image/png" data-filename="Image.png" width="578"/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div>       1. <span style="font-weight: bold;">OnBootSec=15min</span>：</div><div>          systemd-tmpfiles-clean.service服务单元将在系统启动15分钟后被触发</div><div>       2. <span style="font-weight: bold;">OnUnitActiveSec=1d</span>：</div><div>          在上一次激活服务单元24小时后再次触发systemd-tmpfiles-clean.service服务单元</div><div>          的时间</div><div>          <img src="chapter2_files/Image [16].png" type="image/png" data-filename="Image.png" width="540"/>  </div><div><span style="font-weight: bold;">       </span>3. 根据不同要求，可以更改systemd-tmpfiles-clean.timer配置文件中的参数。</div><div>       4. 如，OnUnitActiveSec的值为 30min 时，将在上一次激活服务单元 30 分钟后触发</div><div>          systemd-tmpfiles-clean.service服务单元。</div><div>       5. 因此，在更改生效后将每 30 分钟触发一次systemd-tmpfiles-clean.service。</div><div>       6. <span style="font-weight: bold;">$ sudo systemctl daemon-reload</span></div><div>          # 更改systemd-tmpfiles-clean.timer配置文件后，重新加载配置信息。</div><div>       7. <span style="font-weight: bold;">$ sudo systemctl enable --now systemd-tmpfiles-clean.timer</span></div><div>          # 使该timer unit配置文件立即生效         </div><div><br/></div><div><b>手动清理临时文件：</b></div><ul><li><div>$ man tmpfiles.d：查看systemd-tmpfiles的配置文件格式</div></li><li><div>基本语法由七列构成：类型、路径、模式、UID、GID、期限、参数。</div></li></ul><div><span>     </span><img src="chapter2_files/Image [17].png" type="image/png" data-filename="Image.png" width="442"/><br/></div><div><span>     <b><font style="color: rgb(0, 0, 255);">* 注意：</font></b></span>Age表示文件或目录被删除的时间期限</div><div><span><br/></span></div><ul><li><div>类型指的是systemd-tmpfiles应执行的操作：</div></li></ul><div>     1. <b>d</b>：创建不存在的目录</div><div>     2. <b>Z</b>：以递归方式恢复SELinux context以及权限</div><div>     3. <b>D</b>：如果目录不存在，则创建该目录，如果存在，则清除所有内容。</div><div><br/></div><ul><li><div>示例：</div></li></ul><div><span>     1. </span>在创建文件和目录时，如果目录/run/systemd/seats不存在，则创建该目录，所有者为</div><div><span>    </span><span>    </span>用户root和组root，权限设置为 rwxr-xr-x，系统不会自动清除该目录。 </div><div><span>        </span><img src="chapter2_files/Image [18].png" type="image/png" data-filename="Image.png" width="555"/><br/></div><div><span>     </span><br/></div><div><span>     2. </span>如果目录/home/student不存在，需创建该目录。</div><div><span>    </span><span>    </span>如果存在，则清空其所有内容。</div><div>        <b>运行 </b><b>systemd-tmpfiles --clean 时，删除在超过一天时间内尚未被访问、更改或修改</b></div><div><b>        的所有文件。</b></div><div><b><span>    </span><span>    </span></b><b><img src="chapter2_files/Image [19].png" type="image/png" data-filename="Image.png" width="554"/></b></div><div><b><br/></b></div><div><span>     3. </span>创建指向/etc/fstab的符号链接/run/fstablink。</div><div><span>    </span><span>    </span><b>切勿自动清除这一行！</b><br/></div><div><b><span>    </span><span>    </span></b><b><img src="chapter2_files/Image [20].png" type="image/png" data-filename="Image.png" width="557"/></b></div><div><br/></div><div><b>配置文件的优先级：</b></div><ul><li><div>配置文件可位于三个位置：</div></li></ul><div><span>     </span><b><i><font style="color: rgb(0, 0, 255);">/etc/tmpfiles.d/*.conf</font></i></b>（优先级最高）</div><div><span>     </span>/run/tmpfiles.d/*.conf（优先级次之）</div><div><span>     </span>/usr/lib/tmpfiles.d/*.conf（优先级最低）</div><div><br/></div><ul><li><div>/etc/tmpfiles.d/中的文件旨在供管理员配置自定义临时位置，以及覆盖供应商提供的默认值。</div></li><li><div>/run/tmpfiles.d/中的文件本⾝是易失性文件，通常由守护进程用来管理自己的运行时临时文件。</div></li><li><div>/usr/lib/tmpfiles.d/中的文件是由相关RPM软件包提供的，不应编辑这些文件。</div></li></ul><div><b><br/></b></div><ul><li><div>若/run/tmpfiles.d/中的文件与/usr/lib/tmpfiles.d/中的文件同名，则系统将使用</div></li></ul><div><span>     </span>/run/tmpfiles.d/中的文件。</div><ul><li><div>若/etc/tmpfiles.d/中的文件与/run/tmpfiles.d/或/usr/lib/tmpfiles.d/中的文件同名，</div></li></ul><div>     则系统将使用/etc/tmpfiles.d/中的文件。</div><div><b><br/></b></div><ul><li><div>给定这些优先级规则后，将相关文件复制到/etc/tmpfiles.d/，然后编辑该文件，即可轻松覆盖</div></li></ul><div><span>     </span>供应商提供的设置。</div><ul><li><div><b>如果以这种方式工作，则确保可从中央配置管理系统轻松管理管理员提供的设置，并且软件包的</b></div></li></ul><div><b><span>     </span>更新不会覆盖这些设置。</b></div><div><b><br/></b></div><div><b>     <font color="#FA7A00">练习 P58：MANAGING TEMPORARY FILES</font></b></div><div><b><font color="#FA7A00"><span>     Lab P61：</span>SCHEDULING FUTURE TASKS</font></b></div></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 