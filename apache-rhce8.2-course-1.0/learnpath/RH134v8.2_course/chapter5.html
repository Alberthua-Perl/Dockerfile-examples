<html>
<head>
  <title>第五章 管理SELINUX安全性</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="8734"/>

<div>
<span><div><div><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第五章 管理SELINUX安全性</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>使用SELinux保护和管理服务器的安全性</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>更改SELinux执行模式</div></li><li><div>控制SELinux文件上下文</div></li><li><div>使用布尔值调整SELinux策略</div></li><li><div>调查和解决SELinux问题</div></li></ul><div><br/></div></div><div><br/></div><div><span style="font-weight: bold;">第一节：更改SELinux执行模式</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  解释SELinux如何保护资源</div></li><li><div>  更改系统的当前SELinux模式</div></li><li><div>  设置系统的默认SELinux模式</div></li></ul><div><br/></div></div><div><span style="font-weight: bold;">SELinux如何保护资源：</span></div><ul><li><div>SELinux可允许或拒绝访问文件及其他资源，且精准度相比用户权限大幅提高。</div></li><li><div>SELinux由若干组策略组成，这些策略准确声明了对于应用使用的每个可执行文件、配置文件</div></li></ul><div>     和数据文件，哪些操作和访问是被允许的，这被称为 targeted policy。</div><ul><li><div><span style="font-weight: bold;">策略声明了各个程序、文件和网络端口的预定义 label。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">为什么使用SELinux?</span></div><ul><li><div>并非所有安全问题都可以提前预测。</div></li><li><div>SELinux可以防止因为应用程序的漏洞而影响其他应用访问。</div></li><li><div>SELinux有一个额外的安全层，此外还有一层复杂结构，执行策略意味着系统某一部分的</div></li></ul><div>     弱点不会扩散到其他部分。</div><ul><li><div>SELinux有三种模式：</div></li></ul><div>     1. Enforcing：</div><div>        SELinux强制执行访问控制规则。</div><div>        计算机通常在该模式下运行。</div><div>     2. Permissive：</div><div>        <span style="font-weight: bold;">SELinux处于活动状态，但并不强制执行访问控制规则，而是记录违反规则的日志。</span></div><div>        该模式主要用于测试和故障排除。</div><div>     3. Disabled：</div><div>        SELinux完全关闭（需要系统重启）。</div><div><br/></div><div><span style="font-weight: bold;">SELinux安全的基本概念：</span></div><ul><li><div>大多数Linux管理员都熟悉标准用户、组、其他用户的权限安全模型，SELinux提供另一层安全，</div></li></ul><div>     它基于对象并由更加复杂的规则控制，称为强制访问控制。</div><div><br/></div><ul><li><div>要允许远程匿名访问Web服务器，必须打开防火墙端口。</div></li><li><div>这让恶意人员有机会通过安全漏洞侵入系统。</div></li><li><div>如果成功入侵Web服务器进程，就可以获得apache用户和apache组的权限。</div></li><li><div>该用户和组对文档根目录/var/www/html具有读取权限。</div></li><li><div>它还可以访问/tmp和/var/tmp，以及全局可写的任何文件和目录。</div></li></ul><div><br/></div><ul><li><div>SELinux有一组安全规则，定义进程可以访问哪些文件、目录和端口。</div></li><li><div><span style="font-weight: bold;">每个文件、</span><span style="font-weight: bold;">目录、</span><span style="font-weight: bold;">进程和端口都有专门的安全标签（security label），称为SELinux上下文</span></div></li></ul><div><span style="font-weight: bold;">    （context）。</span></div><ul><li><div><span style="font-weight: bold;">SELinux策略使用上下文来确定某个进程能否访问文件、目录或端口。</span></div></li><li><div>如果没有允许规则，则不允许访问。</div></li></ul><div><br/></div><ul><li><div>SELinux标签具有多种上下文：user、role、type、sensitivity。</div></li><li><div>目标策略（target policy），即RHEL中启用的默认策略会根据类型上下文（type context）</div></li></ul><div>     来制定自己的规则。</div><ul><li><div>type context名称通常以 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">_t</span> 结尾。</div></li></ul><div>     <img src="chapter5_files/Image.png" type="image/png" data-filename="Image.png" width="497"/>     </div><div><br/></div><ul><li><div>Web服务器的类型上下文：<span style="font-weight: bold;">httpd_t</span></div></li><li><div>位于/var/www/html中的文件和目录的类型上下文：<span style="font-weight: bold;">httpd_sys_content_t</span></div></li><li><div>位于/tmp和/var/tmp中的文件和目录的类型上下文：<span style="font-weight: bold;">tmp_t</span></div></li><li><div>Web服务器端口的类型上下文：<span style="font-weight: bold;">http_port_t</span></div></li><li><div>在启用SELinux的情况下，破坏了Web服务器进程的恶意用户将无法访问/tmp目录。</div></li></ul><div><br/></div><ul><li><div>MariaDB服务器的类型上下文：<span style="font-weight: bold;">mysqld_t</span></div></li><li><div>默认情况下，在/data/mysql中的文件具有 <span style="font-weight: bold;">mysqld_db_t</span> 的类型上下文。</div></li><li><div>该类型上下文允许MariaDB访问这些文件，但禁止其他服务（如Apache服务）访问。</div></li></ul><div>     <img src="chapter5_files/Image [1].png" type="image/png" data-filename="Image.png" width="500"/></div><div><br/></div><ul><li><div>许多命令都使用 -Z 选项来显示或设置SELinux上下文，如ps、ls、cp和mkdir。</div></li></ul><div>     <img src="chapter5_files/Image [2].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div><span style="font-weight: bold;">更改当前的SELinux模式：</span></div><ul><li><div>要确定当前的SELinux模式，运行getenforce命令。</div></li><li><div>要将SELinux设置为其他模式，使用setenforce命令（临时生效）。</div></li></ul><div>     <img src="chapter5_files/Image [3].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div><span style="font-weight: bold;">设置默认SELinux模式：</span></div><ul><li><div>/etc/selinux/config文件可永久设置SELinux模式，系统在启动时读取并配置。</div></li></ul><div>     <img src="chapter5_files/Image [4].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P124：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CHANGING THE SELINUX ENFORCEMENT MODE</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：控制SELinux文件上下文</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  使用semanage fcontext命令，管理决定了文件和目录默认上下文的SELinux策略规则。</div></li><li><div>  使用restorecon命令，将SELinux策略所定义的上下文应用到文件和目录。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">初始SELinux上下文：</span></div><ul><li><div>在运行SELinux的系统上，所有进程和文件都有相应的label，代表了与安全有关的信息，称为</div></li></ul><div>     SELinux上下文。</div><ul><li><div><span style="font-weight: bold;">新文件通常从父目录继承其SELinux上下文（mv或cp -a例外）。</span></div></li><li><div>$ ls -Z &lt;<span style="font-style: italic;">filename</span>&gt;：查看文件的SELinux上下文</div></li><li><div>$ ls -dZ &lt;<span style="font-style: italic;">directory</span>&gt;：查看目录的SELinux上下文</div></li></ul><div>     <img src="chapter5_files/Image [5].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div><span style="font-weight: bold;">更改文件的SELinux上下文：</span></div><ul><li><div>命令包括：semanage fcontext、restorecon、chcon。</div></li><li><div>semanage fcontext 命令声明文件的默认标签。</div></li><li><div>restorecon 命令将该上下文应用于文件。</div></li><li><div><span style="font-weight: bold;">chcon 命令更改SELinux上下文，但它不会将上下文更改保存到SELinux上下文数据库中，运行</span></div></li></ul><div><span style="font-weight: bold;">     restorecon 命令后会还原。</span></div><div>     <img src="chapter5_files/Image [6].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div><span style="font-weight: bold;">定义SELinux默认上下文：</span></div><ul><li><div>semanage fcontext 命令可显示和修改 restorecon 用来设置默认文件上下文的规则。</div></li><li><div>它使用扩展正则表达式来指定路径和文件名。</div></li><li><div>fcontext 规则中最常用的扩展正则表达式是 (/.*)?，表示&quot;可选择匹配后跟任何数量字符的 /&quot;。</div></li><li><div>它将会匹配在表达式前面列出的目录并递归地匹配该目录中的所有内容。</div></li></ul><div><br/></div><ul><li><div>semanage fcontext 命令选项：</div></li></ul><div>     <img src="chapter5_files/Image [7].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">policycoreutils</span> 和 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">policycoreutils-python-utils</span> 软件包提供管理SELinux上下文的工具。</div></li></ul><div>     <img src="chapter5_files/Image [8].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>这两个软件包中分别包含 restorecon 命令和 semanage 命令。</div></li><li><div>为了确保目录中的所有文件都具有正确的文件上下文，需先运行 semanage fcontext -l，</div></li></ul><div>     再运行 restorecon 命令。</div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ semanage fcontext -l</span>：查看所有目录的SELinux上下文</div></li></ul><div>     <img src="chapter5_files/Image [9].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ semanage fcontext -a -t &lt;</span><span style="font-style: italic; font-weight: bold;">type_context</span><span style="font-weight: bold;">&gt; '&lt;</span><span style="font-style: italic; font-weight: bold;">directory</span><span style="font-weight: bold;">&gt;(/.*)?'</span></div></li></ul><div>     # 为新目录添加SELinux类型上下文</div><div>     <span style="font-weight: bold;">$ restorecon -Rvv &lt;</span><span style="font-style: italic; font-weight: bold;">directory</span><span style="font-weight: bold;">&gt;</span></div><div>     # 保存新添加目录的类型上下文</div><div>     <img src="chapter5_files/Image [10].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div>     <span style="font-weight: bold;">$ man 8 semanage-fcontext</span>：查看SELinux策略管理文件上下文使用方法</div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P131：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CONTROLLING SELINUX FILE CONTEXTS</span></div><div><br/></div><div><br/></div></div><div><span style="font-weight: bold;">第三节：使用布尔值调整SELinux策略</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  使用setsebool激活/停用SELinux策略规则。</div></li><li><div>  使用semanage boolean -l命令来管理SELinux布尔值的持久值。</div></li><li><div>  查阅以 _selinux 结尾的man page，寻找有关SELinux布尔值的有用信息。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">SELinux布尔值：</span></div><ul><li><div>SELinux布尔值是可更改SELinux策略行为的参数。</div></li><li><div><span style="font-weight: bold;">SELinux布尔值是可以启用或禁用的规则。</span></div></li><li><div>安全管理员可以使用SELinux布尔值来有选择地调整策略。</div></li></ul><div><br/></div><ul><li><div>selinux-policy-doc 软件包附带的SELinux man page中介绍了可用布尔值的用途。</div></li><li><div><span style="font-weight: bold;">$ man -k '_selinux'</span>：列出SELinux可用布尔值的用途</div></li></ul><div><br/></div><ul><li><div>管理SELinux策略布尔值的命令：</div></li></ul><div>     $ getsebool -a：列出所有策略的布尔值及其状态</div><div>     $ getsebool &lt;<span style="font-style: italic;">selinux_policy</span>&gt;：查看指定策略的布尔值与状态</div><div>     $ setsebool &lt;<span style="font-style: italic;">selinux_policy</span>&gt; [on|off]：修改指定策略的布尔值</div><div>     <span style="font-weight: bold;">$ setsebool -P &lt;</span><span style="font-style: italic; font-weight: bold;">selinux_policy</span><span style="font-weight: bold;">&gt; [on|off]</span>：永久更改策略的布尔值</div><div>     <span style="font-weight: bold;">$ semanage boolean -l</span>：查看策略布尔值的当前状态、默认状态与简短描述</div><div><br/></div><ul><li><div>非特权用户可以运行 getsebool 命令。</div></li><li><div>只有超级用户才能运行 semanage boolean -l 和 setsebool -P。</div></li></ul><div>     <img src="chapter5_files/Image [11].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>-P 选项可将策略永久保留</div></li></ul><div>     <img src="chapter5_files/Image [12].png" type="image/png" data-filename="Image.png" width="497"/>          </div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ semanage boolean -l -C</span>：查看当前状态与默认状态不同的策略布尔值</div></li></ul><div>     <img src="chapter5_files/Image [13].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P136：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">ADJUSTING SELINUX POLICY WITH BOOLEANS</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第四节：调查和解决SELinux问题</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  使用SELinux日志分析工具。</div></li><li><div>  使用sealert命令，在SELinux故障排除期间显示有用的信息。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">对SELinux问题进行故障排除：</span></div><ul><li><div>最常见的SELinux问题是使用不正确的文件上下文或设置了不正确的策略布尔值。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">监控SELinux冲突：</span></div><ul><li><div>安装 setroubleshoot-server 软件包，侦听<span style="font-style: italic; font-weight: bold; color: rgb(0, 0, 255);">/var/log/audit/audit.log</span>中的审核消息，</div></li></ul><div>     将SELinux消息发送至<span style="font-style: italic; font-weight: bold; color: rgb(0, 0, 255);">/var/log/messages</span>。</div><ul><li><div>日志包括SELinux冲突的唯一标识符（UUID）。</div></li><li><div><span style="font-weight: bold;">$ sealert -l &lt;</span><span style="font-style: italic; font-weight: bold;">UUID</span><span style="font-weight: bold;">&gt;</span>：用于生成特定事件的报告</div></li><li><div><span style="font-weight: bold;">$ sealert -a /var/log/audit/audit.log</span>：在该文件中生成所有事件的报告</div></li></ul><div><br/></div><ul><li><div>示例：Apache Web服务器SELinux冲突分析</div></li></ul><div>     1. /var/log/audit/audit.log与/var/log/messages日志中记录的SELinux相关信息。</div><div>     <img src="chapter5_files/Image [14].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <img src="chapter5_files/Image [15].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <img src="chapter5_files/Image [16].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     2. 使用sealert命令查看报错的详细信息，该信息对应以上日志文件。</div></div><div>     <img src="chapter5_files/Image [17].png" type="image/png" data-filename="Image.png" width="577"/></div><div>     <img src="chapter5_files/Image [18].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div>     3. <span style="font-weight: bold;">$ ausearch -m AVC -ts recent</span>：在/var/log/audit/audit.log中搜索AVC类型信息</div><div>     <img src="chapter5_files/Image [19].png" type="image/png" data-filename="Image.png" width="578"/></div><div><br/></div><div><span style="font-weight: bold;">Web控制台：</span></div><ul><li><div>使用Web控制台查看SELinux报错信息，如下所示：</div></li></ul><div>     <img src="chapter5_files/Image [20].png" type="image/png" data-filename="Image.png" width="577"/></div><div><br/></div><div>     <font color="#FA7A00"><b>练习 P143：</b><b>INVESTIGATING AND RESOLVING SELINUX ISSUES</b></font></div><div><b><font color="#FA7A00"><span>     Lab P147：</span>MANAGING SELINUX SECURITY<br/></font></b></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 