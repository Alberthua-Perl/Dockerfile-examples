<html>
<head>
  <title>第七章 管理逻辑卷</title>
  <basefont face="Consolas" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/308816 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: Consolas;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="8956"/>

<div>
<span><div><div><div><div><span style="font-size: 12pt; color: rgb(0, 0, 255); font-weight: bold;">第七章 管理逻辑卷</span></div><div><br/></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>使用命令行创建和管理含有文件系统和交换空间的逻辑卷。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">章节：</span></div><ul><li><div>创建逻辑卷</div></li><li><div>扩展逻辑卷</div></li></ul><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第一节：创建逻辑卷</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  描述逻辑卷管理的组件和概念。</div></li><li><div>  实施LVM存储。</div></li><li><div>  显示LVM组件信息。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">逻辑卷管理（LVM）概念：</span></div><ul><li><div>逻辑卷有助于更加轻松地管理磁盘空间。</div></li><li><div>可以将卷组（volume group）中的可用空间分配给逻辑卷（logical volume），并且可以</div></li></ul><div>     调整文件系统的大小。</div><ul><li><div>如果磁盘出现错误，可将替换磁盘注册为物理卷（physical volume）放入卷组中，并将逻辑卷</div></li></ul><div>     的区块迁移到新磁盘。</div><ul><li><div>LVM定义：</div></li></ul><div>     1. 物理设备：</div><div>        a. 用于保存逻辑卷中所存储数据的存储设备。</div><div>        b. 其为块设备，可以是磁盘分区、整个磁盘、RAID阵列或SAN磁盘。</div><div>     2. 物理卷（PV）：</div><div>        a. <span style="font-weight: bold;">物理设备必须初始化为物理卷。</span></div><div>        b. LVM工具会将物理卷划分为物理区块（PE），充当物理卷上最小存储块。</div><div>     3. 卷组（VG）：</div><div>        a. 由一个或多个物理卷组成的存储池。</div><div>        b.<span style="font-weight: bold;"> 一个物理卷只能分配给一个卷组。</span></div><div>        c. 卷组可以包含未使用的空间和任意数目的逻辑卷。</div><div>     4. 逻辑卷（LV）：</div><div>        a. 根据卷组中的空闲物理区块创建。</div><div>        b. <span style="font-weight: bold;">逻辑卷由逻辑区块（LE）组成，LE映射到PE。</span></div><div><br/></div><div><span style="font-weight: bold;">实施LVM存储：</span></div><ul><li><div>实施过程如下所示：</div></li></ul><div>     <span style="font-weight: bold;">block device -</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">PV -</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">VG -</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">LV -</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">file system -</span><span style="font-family: &quot;DejaVu Sans Mono&quot;; font-weight: bold;">&gt;</span> <span style="font-weight: bold;">mount</span></div><div>     <img src="chapter7_files/Image.png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div><span style="font-weight: bold;">创建逻辑卷：</span></div><ul><li><div>准备物理设备：</div></li></ul><div>     1. 使用parted、gdisk或fdisk创建新分区，在LVM分区上，始终将分区类型设置为Linux LVM。</div><div>     2. 对于MBR分区，使用 0x8e。</div><div>     3. 如有必要，使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">partprobe</span> 向内核注册新分区。</div><div>     4. <span style="font-weight: bold;">$ parted -s /dev/sd</span><span style="font-style: italic; font-weight: bold;">X</span> <span style="font-weight: bold;">set &lt;</span><span style="font-style: italic; font-weight: bold;">partition_number</span><span style="font-weight: bold;">&gt; lvm on</span>：设置磁盘分区类型为LVM</div><div>     <img src="chapter7_files/Image [1].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>创建物理卷：</div></li></ul><div>     1. 使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">pvcreate</span> 将分区标记为物理卷。</div><div>     2. pvcreate命令会将物理卷分成若干固定大小的物理区块（PE），如 4MiB。</div><div>     3. <span style="font-weight: bold;">$ pvcreate /dev/sd</span><span style="font-style: italic; font-weight: bold;">X</span><span style="font-weight: bold;">n</span>：将磁盘（分区）创建为物理卷</div><div>     <img src="chapter7_files/Image [2].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>创建卷组：</div></li></ul><div>     1. 使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">vgcreate</span> 将一个或多个物理卷结合为一个卷组。</div><div>     2. <span style="font-weight: bold;">$ vgcreate &lt;</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">pv_name</span><span style="font-weight: bold;">&gt;</span>：创建卷组 </div><div>     <img src="chapter7_files/Image [3].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><ul><li><div>创建逻辑卷：</div></li></ul><div>     1. 使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">lvcreate</span> 可根据卷组中的可用物理区块创建新的逻辑卷。</div><div>     2. -n 选项：设置逻辑卷名称</div><div>        <span style="font-weight: bold;">-l</span> 选项：设置逻辑区块（LE）数量</div><div>        <span style="font-weight: bold;">-L</span> 选项：字节大小</div><div>     3. $ vgs</div><div>        # 查看卷组的空间使用情况</div><div>        <span style="font-weight: bold;">$ lvcreate -L &lt;</span><span style="font-style: italic; font-weight: bold;">lv_size</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">&gt; -n &lt;</span><span style="font-style: italic; font-weight: bold;">lv_name</span><span style="font-weight: bold;">&gt;</span></div><div>        # 指定逻辑卷大小创建逻辑卷</div><div>        <img src="chapter7_files/Image [4].png" type="image/png" data-filename="Image.png" width="475"/></div><div>     4. 逻辑卷路径可表示为 <span style="font-weight: bold;">/dev/</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">/</span><span style="font-style: italic; font-weight: bold;">lv_name</span> 或 <span style="font-weight: bold;">/dev/mapper/</span><span style="font-style: italic; font-weight: bold;">vg_name-lv_name</span></div><div><br/></div><ul><li><div>添加文件系统：</div></li></ul><div>     使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">mkfs</span> 在新逻辑卷上创建文件系统，创建挂载点，并挂载文件系统。</div><div>     <img src="chapter7_files/Image [5].png" type="image/png" data-filename="Image.png" width="499"/></div></div><div><br/></div><div>   <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span>文件系统类型错误导致系统启动失败</div><div>     1. 由于系统无法正确挂载/etc/fstab中指定的卷，而进入救援模式（maintenance）。</div><div>     2. <b>救援</b><span style="font-weight: bold;">模式下不启用Linux网络栈！</span></div><div>     <img src="chapter7_files/Image [6].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     3. 查看系统中已有的存储卷信息</div><div>     <img src="chapter7_files/Image [7].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div>     4. 修改/etc/fstab中的相应条目，重启系统即可成功。</div><div>     <img src="chapter7_files/Image [8].png" type="image/png" data-filename="Image.png" width="443"/></div><div><br/></div><div><span style="font-weight: bold;">删除逻辑卷：</span></div><ul><li><div>umount并vim /etc/fstab取消文件系统挂载</div></li><li><div>$ lvremove &lt;<span style="font-style: italic;">lv_name</span>&gt;：删除不需要的逻辑卷</div></li><li><div>$ vgremove &lt;<span style="font-style: italic;">vg_name</span>&gt;：删除卷组</div></li><li><div>$ pvremove &lt;<span style="font-style: italic;">pv_name</span>&gt;：删除物理卷</div></li></ul><div><br/></div><div><span style="font-weight: bold;">查看LVM状态信息：</span></div><ul><li><div>$ pvdisplay &lt;<span style="font-style: italic;">pv_name</span>&gt;：查看物理卷信息</div></li></ul><div>     <img src="chapter7_files/Image [9].png" type="image/png" data-filename="Image.png" width="498"/>     </div><div><br/></div><ul><li><div>$ vgdisplay &lt;<span style="font-style: italic;">vg_name</span>&gt;：查看卷组信息</div></li></ul><div>     <img src="chapter7_files/Image [10].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><ul><li><div>$ lvdisplay &lt;<span style="font-style: italic;">lv_name</span>&gt;：查看逻辑卷信息</div></li></ul><div>     <img src="chapter7_files/Image [11].png" type="image/png" data-filename="Image.png" width="498"/></div><div>     <img src="chapter7_files/Image [12].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P195：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">CREATING LOGICAL VOLUMES</span></div><div><br/></div><div><br/></div><div><span style="font-weight: bold;">第二节：扩展逻辑卷</span></div><div><span style="font-weight: bold;">目标：</span></div><ul><li><div>完成本节后，学生应该能：</div></li><li><div>  使用pvcreate和vgextend扩展VG，并使用vgdisplay验证结果。</div></li><li><div>  使用pvmove和vgreduce缩减VG。</div></li><li><div>  使用lvextend扩展LV。</div></li><li><div>  通过xfs_growfs调整XFS文件系统的大小。</div></li><li><div>  通过resize2fs调整ext4文件系统的大小。</div></li></ul><div><br/></div><div><span style="font-weight: bold;">扩展和缩减卷组：</span></div><ul><li><div>可通过添加额外的物理卷来为卷组增加更多磁盘空间。</div></li><li><div>然后，可从额外的物理卷中为逻辑卷分配新的物理区块。</div></li></ul><div><br/></div><ul><li><div>未使用的物理卷可以从卷组中删除。</div></li><li><div><span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">pvmove</span> <span style="font-weight: bold;">命令可将数据从一个物理卷上的区块移动到卷组中其他物理卷上的区块。</span></div></li><li><div>通过这种方式，可以将新磁盘添加到现有卷组，将数据从较旧或较慢的磁盘移动到新磁盘，并</div></li></ul><div>     将旧磁盘从卷组中删除。</div><ul><li><div><span style="font-weight: bold;">可在卷组中的逻辑卷正在使用时执行这些操作。</span></div></li></ul><div><br/></div><div><span style="font-weight: bold;">扩展卷组：</span></div><ul><li><div>准备物理设备并创建物理卷</div></li></ul><div>     <img src="chapter7_files/Image [13].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>扩展卷组：<span style="font-weight: bold;">$ vgextend &lt;</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">pv_name</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     <img src="chapter7_files/Image [14].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><ul><li><div>验证新空间是否可用</div></li></ul><div>     <img src="chapter7_files/Image [15].png" type="image/png" data-filename="Image.png" width="497"/></div><div><br/></div><div><span style="font-weight: bold;">缩减卷组：</span></div><ul><li><div>移动物理区块：</div></li></ul><div>     1. <span style="font-weight: bold;">$ pvmove &lt;</span><span style="font-style: italic; font-weight: bold;">pv_name</span><span style="font-weight: bold;">&gt;</span>：将要删除的PV中的所有PE都重新放置到VG中的其他PV上</div><div>     2. 其他VG中必须有足够数量的空闲区块来容纳这些移动内容。</div><div>     3. <span style="font-weight: bold;">仅当VG中存在足够的空闲区块，且所有这些区块都来自其他PV时，才能执行此操作！</span></div><div><br/></div><ul><li><div>缩减卷组：<span style="font-weight: bold;">$ vgreduce &lt;</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">&gt; &lt;</span><span style="font-style: italic; font-weight: bold;">pv_name</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     <img src="chapter7_files/Image [16].png" type="image/png" data-filename="Image.png" width="498"/></div><div><br/></div><div>     <span style="color: rgb(0, 0, 255); font-weight: bold;">* 注意：</span></div><div><span style="font-weight: bold;">    </span><span style="font-weight: bold;">   </span>1. 使用pvmove前，备份卷组中所有逻辑卷上存储的数据。</div><div>       2. 如果操作期间意外断电，可能会导致卷组状态不一致。</div><div>       3. 这可能导致卷组中逻辑卷上的数据丢失。 </div><div><br/></div><div><span style="font-weight: bold;">扩展逻辑卷：</span></div><ul><li><div><span style="font-weight: bold;">逻辑卷的一个优势在于能够在不停机的情况下增加其大小。</span></div></li><li><div>可将卷组中的空闲物理区块添加到逻辑卷以扩展其容量，然后可使用逻辑卷扩展所包含的</div></li></ul><div>     文件系统。</div><div><br/></div><ul><li><div>使用vgdisplay验证卷组是否具有可用的空间。</div></li></ul><div><span style="font-weight: bold;">     </span><span style="font-weight: bold;"><img src="chapter7_files/Image [17].png" type="image/png" data-filename="Image.png" width="497"/></span></div></div><div><br/></div><ul><li><div>使用 <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">lvextend</span> 命令扩展逻辑卷。</div></li></ul><div><span style="font-weight: bold;">     </span><span style="font-weight: bold;"><img src="chapter7_files/Image [18].png" type="image/png" data-filename="Image.png" width="498"/></span></div><div><br/></div><ul><li><div>逻辑卷扩展常用示例：</div></li></ul><div>     <img src="chapter7_files/Image [19].png" type="image/png" data-filename="Image.png" width="499"/></div><div>     <img src="chapter7_files/Image [20].png" type="image/png" data-filename="Image.png" width="499"/></div><div><br/></div><div><span style="font-weight: bold;">扩展文件系统：XFS、ext3/4</span></div><ul><li><div><span style="font-weight: bold;">$ xfs_growfs &lt;</span><span style="font-style: italic; font-weight: bold;">mount_point</span><span style="font-weight: bold;">&gt;</span></div></li></ul><div>     # 在线动态扩展XFS文件系统，在调整文件系统大小时，可以继续使用该文件系统。</div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ lvextend</span> <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">-r</span> <span style="font-weight: bold;">-L [+]&lt;</span><span style="font-style: italic; font-weight: bold;">size</span><span style="font-weight: bold;">&gt; /dev/</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">/</span><span style="font-style: italic; font-weight: bold;">lv_name</span></div></li></ul><div>     # 扩展逻辑卷容量，并在线动态扩展相应类型的文件系统。</div><div><br/></div><ul><li><div><span style="font-weight: bold;">$ resize2fs </span><span style="font-weight: bold;">/dev/</span><span style="font-style: italic; font-weight: bold;">vg_name</span><span style="font-weight: bold;">/</span><span style="font-style: italic; font-weight: bold;">lv_name</span><span style="font-style: italic;"> </span></div></li></ul><div>     # 在线动态扩展ext3/4文件系统，运行该命令时可挂载并使用该文件系统。</div><div>     # <span style="color: rgb(0, 0, 255); font-style: italic; font-weight: bold;">-p</span> 选项用于监控调整大小操作的进度</div><div><br/></div><div><span style="color: rgb(0, 0, 255); font-weight: bold;">     * 注意：</span></div><div>       1. xfs_growfs与resize2fs之间的主要区别是为识别文件系统⽽传递的参数。</div><div>       2. xfs_growfs采⽤挂载点，而resize2fs采用逻辑卷名称。 </div><div>       3. <span style="font-weight: bold;">ext3/4文件系统支持逻辑卷收缩，XFS文件系统不支持逻辑卷收缩！ </span><span style="font-weight: bold;"> </span></div><div><br/></div><div><span style="font-weight: bold;">扩展逻辑卷和交换空间：</span></div><ul><li><div>格式化为交换空间的逻辑卷也可以进⾏扩展，但该过程与扩展文件系统（如ext4或XFS）</div></li></ul><div>     的过程有所不同。</div><ul><li><div>格式化为相应文件系统的逻辑卷可进行动态扩展，无需停机。</div></li><li><div><span style="font-weight: bold;">格式化为交换空间的逻辑卷则必须脱机才能进行扩展！</span></div></li></ul><div><br/></div><ul><li><div><span style="font-weight: bold;">扩展SAWP空间：</span></div></li></ul><div>     $ swapoff -v /dev/<span style="font-style: italic;">vg_name</span>/<span style="font-style: italic;">lv_name</span></div><div>     # 停用逻辑卷上的交换空间</div><div>     # <span style="font-weight: bold;">系统必须有足够的可⽤内存或交换空间，以便在停⽤逻辑卷上的交换空间时能接受</span></div><div><span style="font-weight: bold;">       需要置入的任何内容！</span></div><div><br/></div><div><span style="font-weight: bold;">     </span>$ lvextend -L +&lt;<span style="font-style: italic;">size</span>&gt; /dev/<span style="font-style: italic;">vg_name</span>/<span style="font-style: italic;">lv_name</span> <span style="font-weight: bold;">      </span></div><div>     # 扩展交换空间逻辑卷</div><div><br/></div><div>     $ mkswap /dev/<span style="font-style: italic;">vg_name</span>/<span style="font-style: italic;">lv_name</span></div><div>     # 重新格式化交换空间逻辑卷</div><div><br/></div><div>     $ swapon -av /dev/<span style="font-style: italic;">vg_name</span>/<span style="font-style: italic;">lv_name</span></div><div><span style="font-style: italic;">     </span># 重新激活交换空间逻辑卷</div><div><br/></div><div>     <span style="color: rgb(250, 122, 0); font-weight: bold;">练习 P205：</span><span style="color: rgb(250, 122, 0); font-weight: bold;">EXTENDING LOGICAL VOLUMES</span></div><div><span style="color: rgb(250, 122, 0); font-weight: bold;">     Lab P209：MANAGING LOGICAL VOLUMES</span></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 